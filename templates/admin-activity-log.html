<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Instaprint Dashboard</title>
    <link
      rel="icon"
      type="image/jpeg"
      href="{{ url_for('static', filename='images/logo.jpg') }}"
    />
    <link href="/static/css/admin-dashboard.css" rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      /* CSS for layout, ensuring menu and content are positioned correctly */
      .container {
        display: flex;
      }
      .menu {
        flex-shrink: 0; /* Prevents the menu from shrinking */
      }
      .contents {
        flex-grow: 1; /* Allows the content area to take up the remaining space */
        padding: 20px;
      }
      /* Styles for the log table (can be expanded in admin-dashboard.css) */
      .log-table {
        margin-top: 20px;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        overflow: hidden; /* Ensures box-shadow is visible around rounded corners */
      }
      .log-header,
      .log-entry {
        display: flex;
        border-bottom: 1px solid #eee;
      }
      .log-header {
        background-color: #f8f9fa; /* Light grey background for header */
        font-weight: bold;
        color: #333;
      }
      .log-header > div,
      .log-entry > div {
        padding: 12px 15px;
        text-align: left;
      }
      .log-entry:last-child {
        border-bottom: none;
      }
      .log-date {
        flex: 0 0 200px; /* Fixed width for date/time column */
        color: #555;
      }
      .log-event {
        flex-grow: 1; /* Event column takes remaining space */
        color: #444;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <leftmenu class="menu">
        <div class="account">
          <img
            src="{{ url_for('static', filename='images/logo.jpg') }}"
            alt="InstaPrint Logo"
            class="profile-icon"
            style="max-width: 75px"
          />
          <div class="account-info">
            <p class="name">InstaPrint</p>
            <p class="role">Admin</p>
          </div>
        </div>

        <h2>Navigation</h2>
        <ul>
          <li>
            <i class="fa-solid fa-house"></i>
            <a href="{{ url_for('admin_dashboard') }}">Dashboard</a>
          </li>
          <li>
            <i class="fa-solid fa-print"></i>
            <a href="{{ url_for('admin_printed_pages') }}">Files Upload</a>
          </li>
          <li>
            <i class="fa-solid fa-comments"></i>
            <a href="{{ url_for('admin_feedbacks') }}">Feedbacks</a>
          </li>
          <li>
            <i class="fa-solid fa-upload"></i>
            <a href="{{ url_for('admin_activity_log') }}">Activity Log</a>
          </li>
          <li>
            <i class="fa-solid fa-chart-bar"></i>
            <a href="{{ url_for('admin_sales') }}">Total Sales</a>
          </li>
        </ul>
      </leftmenu>

      <content class="contents">
        <div class="log-table" id="activityLogContainer">
          <!-- Logs will be dynamically injected here -->
          <p>Loading activity logs...</p>
        </div>
      </content>
    </div>

    <script>
      function sanitizeHTML(str) {
        const temp = document.createElement('div');
        temp.textContent = str;
        return temp.innerHTML;
      }

      function loadActivityLogs() {
        fetch("/admin_activity_data") // This route now fetches from ErrorLog table
          .then((response) => {
            if (!response.ok) {
                // Try to get error message from response if possible
                return response.json().then(errData => {
                    throw new Error(`HTTP error! Status: ${response.status}, Message: ${errData.error || response.statusText}`);
                }).catch(() => { // Fallback if response is not JSON or no error field
                    throw new Error(`HTTP error! Status: ${response.status} ${response.statusText}`);
                });
            }
            return response.json();
          })
          .then((data) => {
            const container = document.getElementById("activityLogContainer");
            container.innerHTML = ""; // Clear previous logs (header is separate now)

            if (data.error) {
                container.innerHTML = `<p class="no-logs">Error loading logs: ${sanitizeHTML(data.error)}. Details: ${sanitizeHTML(data.details || '')}</p>`;
                console.error("Error from /admin_activity_data:", data.error, data.details);
                return;
            }

            if (!Array.isArray(data) || data.length === 0) {
              container.innerHTML = '<p class="no-logs">No error logs found.</p>';
              return;
            }

            // Data is already sorted by timestamp desc from backend
            data.forEach((log) => {
              const logEntry = document.createElement("div");
              logEntry.classList.add("log-entry");
              logEntry.setAttribute('role', 'row');

              const detailsHTML = log.details ? `<div class="log-details" role="cell" aria-hidden="true">${sanitizeHTML(log.details)}</div>` : '';

              logEntry.innerHTML = `
                <div class="log-date" role="cell">${sanitizeHTML(log.timestamp)}</div>
                <div class="log-source" role="cell">${sanitizeHTML(log.source || 'N/A')}</div>
                <div class="log-event" role="cell" tabindex="0" aria-expanded="false" aria-controls="details-${log.id}">${sanitizeHTML(log.message)}</div>
                ${detailsHTML}
              `;
              
              const eventDiv = logEntry.querySelector('.log-event');
              const detailsDiv = logEntry.querySelector('.log-details');

              if (detailsDiv) {
                eventDiv.addEventListener('click', () => toggleDetails(eventDiv, detailsDiv));
                eventDiv.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        toggleDetails(eventDiv, detailsDiv);
                        e.preventDefault();
                    }
                });
              }
              container.appendChild(logEntry);
            });
          })
          .catch((err) => {
            console.error("Failed to load activity logs:", err);
            const container = document.getElementById("activityLogContainer");
            container.innerHTML = `<p class="no-logs">Error loading logs: ${sanitizeHTML(err.message)}. Check console.</p>`;
          });
      }

      function toggleDetails(eventDiv, detailsDiv) {
        const isHidden = detailsDiv.style.display === 'none' || detailsDiv.style.display === '';
        detailsDiv.style.display = isHidden ? 'block' : 'none';
        eventDiv.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
        detailsDiv.setAttribute('aria-hidden', isHidden ? 'false' : 'true');
      }

      // Initial load
      loadActivityLogs();

      // Refresh logs periodically (e.g., every 30 seconds)
      setInterval(loadActivityLogs, 30000);
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="./../static/js/main.js"></script>
  </body>
</html>
