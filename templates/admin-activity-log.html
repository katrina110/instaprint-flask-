<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instaprint Dashboard</title>
    <link rel="icon" type="image/jpeg" href="{{ url_for('static', filename='images/logo.jpg') }}">
    <link href="/static/css/admin-dashboard.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* CSS for layout, ensuring menu and content are positioned correctly */
        .container {
            display: flex;
        }
        .menu {
            flex-shrink: 0; /* Prevents the menu from shrinking */
        }
        .contents {
            flex-grow: 1; /* Allows the content area to take up the remaining space */
            padding: 20px;
        }
        /* Styles for the log table (can be expanded in admin-dashboard.css) */
        .log-table {
            margin-top: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden; /* Ensures box-shadow is visible around rounded corners */
        }
        .log-header, .log-entry {
            display: flex;
            border-bottom: 1px solid #eee;
        }
        .log-header {
            background-color: #f8f9fa; /* Light grey background for header */
            font-weight: bold;
            color: #333;
        }
        .log-header > div, .log-entry > div {
            padding: 12px 15px;
            text-align: left;
        }
        .log-entry:last-child {
            border-bottom: none;
        }
        .log-date {
            flex: 0 0 200px; /* Fixed width for date/time column */
            color: #555;
        }
        .log-event {
            flex-grow: 1; /* Event column takes remaining space */
            color: #444;
        }
    </style>
</head>
<body>
    <div class="container">
        <leftmenu class="menu">
            <div class="account">
                <img src="{{ url_for('static', filename='images/logo.jpg') }}" alt="InstaPrint Logo" class="profile-icon" style="max-width: 75px;">
                <div class="account-info">
                    <p class="name">InstaPrint</p>
                    <p class="role">Admin</p>
                </div>
            </div>

            <h2>Navigation</h2>
            <ul>
                <li><i class="fa-solid fa-house"></i> <a href="{{ url_for('admin_dashboard') }}">Dashboard</a></li>
                <li><i class="fa-solid fa-print"></i> <a href="{{ url_for('admin_printed_pages') }}">Files Upload</a></li>
                <li><i class="fa-solid fa-comments"></i> <a href="{{ url_for('admin_feedbacks') }}">Feedbacks</a></li>
                <li><i class="fa-solid fa-upload"></i> <a href="{{ url_for('admin_activity_log') }}">Activity Log</a></li>
                <li><i class="fa-solid fa-chart-bar"></i> <a href="{{ url_for('admin_sales') }}">Total Sales</a></li> 
            </ul>            
        </leftmenu>

        <content class="contents">
            <div class="log-table">
                <div class="log-header">
                    <div class="log-date">Date & Time</div>
                    <div class="log-event">Event Name</div>
                </div>
                {% for log in printed %}
                <div class="log-entry">
                    <div class="log-date">{{ log.date }}<br>{{ log.time }}</div>
                    <div class="log-event">{{ log.event }}</div>
                </div>
                {% endfor %}
            </div>
        </content>
    </div>
    
    <script>
        // Poll the backend every 5 seconds for updated printer status
        // Ensure this dynamic update logic correctly targets elements if structure changes.
        // The current logic re-writes innerHTML of .log-table.
        const logTableContainer = document.querySelector('.log-table'); // Target the main container

        function updateActivityLog() {
            fetch('/api/printer-status')
                .then(response => response.json())
                .then(data => {
                    if (!logTableContainer) return;

                    // Preserve header, clear only log entries
                    const existingEntries = logTableContainer.querySelectorAll('.log-entry');
                    existingEntries.forEach(entry => entry.remove());

                    // Add the new log entries dynamically
                    if (data && data.length > 0) {
                        data.forEach(log => {
                            const entryDiv = document.createElement('div');
                            entryDiv.classList.add('log-entry');
                            entryDiv.innerHTML = `
                                <div class="log-date">${log.date}<br>${log.time}</div>
                                <div class="log-event">${log.event}</div>
                            `;
                            logTableContainer.appendChild(entryDiv);
                        });
                    } else {
                        // Optional: Show a message if no logs
                        // const noLogsMsg = document.createElement('div');
                        // noLogsMsg.classList.add('log-entry'); // Use same class for padding
                        // noLogsMsg.innerHTML = `<div style="text-align:center; width:100%;">No new activity.</div>`;
                        // logTableContainer.appendChild(noLogsMsg);
                    }
                })
                .catch(error => {
                    console.error("Error fetching printer status:", error);
                });
        }

        // Initial call and then set interval
        if (logTableContainer) { // Only run if the container exists
             updateActivityLog(); // Load logs immediately
             setInterval(updateActivityLog, 5000); // Update every 5 seconds
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="./../static/js/main.js"></script>
</body>
</html>