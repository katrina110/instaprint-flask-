<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Result Page</title>
    <link
      rel="icon"
      href="{{ url_for('static', filename='images/logo.jpg') }}"
      type="image/x-icon"
    />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <link href="./../static/css/result.css" rel="stylesheet" />
    <link href="./../static/css/header.css" rel="stylesheet" />
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script> 
  </head>
  <style>
      /* define thumbnail dimensions for each size/orientation */
      .thumb-A4.portrait {
        width: 150px;
        height: 210px;
      }
      .thumb-A4.landscape {
        width: 210px;
        height: 150px;
      }
      .thumb-Short.portrait {
        width: 150px;
        height: 192px;
      }
      .thumb-Short.landscape {
        width: 192px;
        height: 150px;
      }
      .thumb-Long.portrait {
        width: 150px;
        height: 250px;
      }
      .thumb-Long.landscape {
        width: 250px;
        height: 150px;
      }
      .thumb-container {
        overflow: hidden;
        border: 1px solid #ccc;
        margin: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .thumb-container img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
      }

      .page-button {
        width: 50px;
        height: 50px;
        margin: 4px;
        border: 2px solid #ccc;
        border-radius: 25px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        user-select: none;
        touch-action: manipulation;
      }
      .page-button.selected {
        border-color: #007bff;
        background-color: rgba(0, 123, 255, 0.1);
      }
      #printDetails {
        max-width: 100%;
        margin: 0 auto;
        box-sizing: border-box; 
        word-wrap: break-word; 
        overflow-wrap: break-word; 
      }
      h3 {
        text-align: center;
        color: #333;
        font-size: 1.5rem;
      }
      ul {
        list-style: none;
        padding: 0;
      }
      li {
        font-size: 1rem;
        line-height: 1.5;
        color: #555;
        word-wrap: break-word; 
      }
      li strong {
        font-weight: bold;
      }

      @media (max-width: 600px) {
        li {
          font-size: 0.9rem; 
        }
        h3 {
          font-size: 1.2rem;
        }
      }

      @media (max-width: 400px) {
        li {
          font-size: 0.8rem; 
        }
        h3 {
          font-size: 1rem;
        }
      }

      #editModal .modal-content {
        max-height: 92vh;     
        overflow: hidden;       
        display: flex;          
        flex-direction: column; 
      }

      #editModal .modal-body {
        flex-grow: 1;       
      }
    </style>
  <body>
    <header class="header">
      <img src="./../static/images/pup-logo.png" alt="logo" />
      <div class="center-text" style="background-color: white">
        INSTAPRINT
        <h6>PRINT PREVIEW RESULTS</h6>
      </div>
      <img src="./../static/images/cpe-logo.png" alt="logo" />
    </header>
    <div class="result-container">
      <div class="row">
        <div class="column left" style="margin-top: 3rem">
          <div id="printDetails" class="mb-4"></div>
          <div class="button">
            <button
              class="btn edit-btn mt-3"
              id="editButton"
              data-toggle="modal"
              data-target="#editModal"
            >
              Edit Print Options
            </button>
            <h3 class="mt-4" id="totalPrice">
              Total Price: ₱<span id="priceValue">0.00</span>
            </h3>
            <button class="btn btn-success mt-3" id="printButton" style="border-radius: 25px;">
              Start Printing
            </button>

            <a href="{{ url_for('online_upload') }}" class="btn edit-btn mt-3">Cancel</a>

          </div>
        </div>
        <div class="column right">
          <h2>Page Previews</h2>
          <div id="previewContainer" class="d-flex flex-wrap"></div>
          <h2 class="mt-5">Segmented Images and Price Breakdown</h2>
          <div id="segmentedContainer" class="d-flex flex-wrap"></div>
        </div>
      </div>
    </div>

     <div
      class="modal fade"
      id="editModal"
      tabindex="-1"
      aria-labelledby="editModalLabel"
      aria-hidden="true"
      data-backdrop="static" 
      data-keyboard="false"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header" style="border-radius: 25px;">
            <h5 class="modal-title" id="editModalLabel">Edit Print Options</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form id="editForm">
              <div class="form-group">
                <label>Pages to Print</label>
                <div
                  id="editPageSelectionContainer"
                  class="d-flex flex-wrap"
                ></div>
                <input
                  type="hidden"
                  id="editPageSelection"
                  name="pageSelection"
                  required
                />
              </div>

              <div class="form-group">
                <label for="editNumCopies">Number of Copies</label>
                <input
                  type="number"
                  class="form-control"
                  id="editNumCopies"
                  name="numCopies"
                  min="1"
                  required
                />
              </div>
              <div class="form-group">
                <label for="editOrientationOption">Orientation</label>
                <select
                  id="editOrientationOption"
                  name="orientationOption"
                  class="form-control"
                >
                  <option value="portrait">Portrait</option>
                  <option value="landscape">Landscape</option>
                  <option value="auto">Auto</option>
                </select>
              </div>

              <div class="form-group">
                <label for="editPageSize">Page Size</label>
                <select
                  class="form-control"
                  id="editPageSize"
                  name="pageSize"
                  required
                  disabled
                >
                  <option value="Short" selected>Short</option>
                </select>
              </div>

              <div class="form-group">
                <label for="editColorOption">Color Option</label>
                <select
                  class="form-control"
                  id="editColorOption"
                  name="colorOption"
                  required
                >
                  <option value="Color">Color</option>
                  <option value="Grayscale">Grayscale</option>
                </select>
              </div>
              <button type="submit" class="btn btn-primary">
                Apply Changes
              </button>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="myModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Thank You for Using InstaPrint!</h2>
        <p>Your document is now being processed and will start to print soon.</p>
        <h3>Rate Your Experience:</h3>
        <div class="star-rating">
          <input type="radio" id="star5" name="rating" value="5"><label for="star5" title="5 stars">☆</label>
          <input type="radio" id="star4" name="rating" value="4"><label for="star4" title="4 stars">☆</label>
          <input type="radio" id="star3" name="rating" value="3"><label for="star3" title="3 stars">☆</label>
          <input type="radio" id="star2" name="rating" value="2"><label for="star2" title="2 stars">☆</label>
          <input type="radio" id="star1" name="rating" value="1"><label for="star1" title="1 star">☆</label>
        </div>
        <br>
        <h4>Give Us Your Feedback</h4>
        <img src="{{ url_for('static', filename='images/feedback_qr.png') }}" alt="Feedback QR Code" />
        <p class="amount"><i>Redirecting to home page after 30 seconds.</i></p>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
          let previewsData = [];

          // Log Error function
          function logError(message, details) {
              console.error("Client-side error:", message, details);
              fetch('/log_activity', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                      message: String(message),
                      source: 'result.html',
                      details: details ? String(details) : null
                  })
              }).catch(err => console.error("Failed to send client-side error to backend:", err));
          }

          function parseSelection(str) {
              const pages = new Set();
              (str || "").split(",").forEach((token) => {
                  token = token.trim();
                  if (!token) return;
                  if (token.includes("-")) {
                      let [s, e] = token.split("-").map(Number);
                      if (s > e) [s, e] = [e, s];
                      for (let i = s; i <= e; i++) pages.add(String(i));
                  } else if (!isNaN(parseInt(token, 10))) {
                      pages.add(token);
                  }
              });
              return pages;
          }

          function thumbClass(size, orient) {
              const o = orient === "auto" ? "portrait" : orient;
              return `thumb-${size} ${o}`;
          }

          function refreshUI(options) {
              if (!options || !options.fileName) {
                  console.error("Print options not found in sessionStorage or fileName is missing. Key: printOptions", options);
                  alert("Error: Print options are missing. Please start over from the upload page.");
                  document.getElementById("printDetails").innerHTML = "<p class='text-danger'>Could not load print details.</p>";
                  document.getElementById("previewContainer").innerHTML = "";
                  document.getElementById("segmentedContainer").innerHTML = "";
                  document.getElementById("priceValue").textContent = "0.00";
                  return;
              }

              document.getElementById("printDetails").innerHTML = `
                  <h3>Selected Options:</h3>
                  <ul>
                      <li><strong>File:</strong> ${options.fileName}</li>
                      <li><strong>Pages:</strong> ${options.pageSelection || 'All'}</li>
                      <li><strong>Copies:</strong> ${options.numCopies || 1}</li>
                      <li><strong>Orientation:</strong> ${options.orientationOption || 'auto'}</li>
                      <li><strong>Page Size:</strong> ${options.pageSize || 'A4'}</li>
                      <li><strong>Color:</strong> ${options.colorOption || 'Color'}</li>
                  </ul>
              `;

              document.getElementById("editPageSelection").value = options.pageSelection || "";
              document.getElementById("editNumCopies").value = options.numCopies || 1;
              document.getElementById("editOrientationOption").value = options.orientationOption || "auto";
              document.getElementById("editPageSize").value = "Short"; // Always set to Short
              document.getElementById("editColorOption").value = options.colorOption || "Color";

              fetch("/preview_with_price", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(options),
              })
                  .then(async (response) => {
                      if (!response.ok) {
                          const errorData = await response.json().catch(() => ({ error: `HTTP error ${response.status}` }));
                          throw new Error(errorData.error || `HTTP error ${response.status}`);
                      }
                      return response.json();
                  })
                  .then((data) => {
                      if (data.error) {
                          console.error("Error from /preview_with_price:", data.error);
                          alert("Error from server: " + data.error);
                          document.getElementById("previewContainer").innerHTML = `<p class="text-danger">${data.error}</p>`;
                          document.getElementById("segmentedContainer").innerHTML = "";
                          document.getElementById("priceValue").textContent = "0.00";
                          return;
                      }

                      document.getElementById("priceValue").textContent = data.totalPrice.toFixed(2);

                      const pC = document.getElementById("previewContainer");
                      const sC = document.getElementById("segmentedContainer");
                      pC.innerHTML = "";
                      sC.innerHTML = "";

                      if (data.pagePrices && Array.isArray(data.pagePrices)) {
                          data.pagePrices.forEach((p) => {
                              const thumb = document.createElement("div");
                              thumb.className = "thumb-container " + thumbClass(options.pageSize, options.orientationOption);
                              const img = document.createElement("img");
                              img.src = p.original;
                              img.style.cursor = "pointer";
                              if (options.colorOption === "Grayscale") {
                                  img.style.filter = "grayscale(100%)";
                              }
                              img.addEventListener("click", () => showModal(p.original));
                              thumb.appendChild(img);
                              pC.appendChild(thumb);

                              const seg = document.createElement("div");
                              seg.className = "m-2 p-2 border";
                              seg.innerHTML = `<p>Page ${p.page} (₱${p.price.toFixed(2)}):</p>`;
                              const segImg = document.createElement("img");
                              segImg.src = p.highlighted;
                              segImg.style = "max-width:200px; cursor:pointer;";
                              segImg.addEventListener("click", () => showModal(p.highlighted));
                              seg.appendChild(segImg);
                              sC.appendChild(seg);
                          });
                      } else {
                          console.warn("data.pagePrices is missing or not an array", data);
                          sC.innerHTML = "<p>Could not load price breakdown.</p>";
                      }

                      const grid = document.getElementById("editPageSelectionContainer");
                      grid.innerHTML = "";
                      const totalPages = data.totalPages;
                      const selectedPages = parseSelection(options.pageSelection);

                      for (let i = 1; i <= totalPages; i++) {
                          const btn = document.createElement("div");
                          btn.className = "page-button";
                          btn.textContent = i;
                          if (selectedPages.has(String(i))) btn.classList.add("selected");
                          btn.addEventListener("click", () => {
                              const nowSelected = btn.classList.toggle("selected");
                              if (nowSelected) selectedPages.add(String(i));
                              else selectedPages.delete(String(i));
                              document.getElementById("editPageSelection").value = Array.from(selectedPages).sort((a, b) => Number(a) - Number(b)).join(",");
                          });
                          grid.appendChild(btn);
                      }
                      document.getElementById("editPageSelection").value = Array.from(selectedPages).sort((a, b) => Number(a) - Number(b)).join(",");

                      previewsData = data.previews || [];
                  })
                  .catch((error) => {
                      console.error("Failed to load preview data:", error);
                      alert("Failed to load preview data. Please try again. Details: " + error.message);
                      document.getElementById("previewContainer").innerHTML = `<p class="text-danger">Could not load previews. ${error.message}</p>`;
                      document.getElementById("segmentedContainer").innerHTML = "";
                      document.getElementById("priceValue").textContent = "0.00";
                  });
          }

          let opts = JSON.parse(sessionStorage.getItem("printOptions")) || {};
          refreshUI(opts);

          document.getElementById("editForm").addEventListener("submit", (e) => {
              e.preventDefault();
              const updated = {
                  fileName: opts.fileName,
                  originalDownloadName: opts.originalDownloadName,
                  pageSelection: document.getElementById("editPageSelection").value,
                  numCopies: parseInt(document.getElementById("editNumCopies").value, 10),
                  orientationOption: document.getElementById("editOrientationOption").value,
                  pageSize: "Short", // Force pageSize to "Short" when applying changes
                  colorOption: document.getElementById("editColorOption").value,
              };
              opts = updated;
              sessionStorage.setItem("printOptions", JSON.stringify(updated));
              refreshUI(updated);
              $("#editModal").modal("hide");
          });

          document.getElementById("printButton").addEventListener("click", (ev) => {
              ev.preventDefault();
              const currentPrice = parseFloat(document.getElementById("priceValue").textContent);
              // This check ensures that the previews have been loaded successfully from /preview_with_price
              if (!previewsData || previewsData.length === 0) {
                  alert("Preview data is not available. Cannot proceed to printing.");
                  console.error("previewsData is empty or not loaded:", previewsData);
                  return;
              }

              // The 'fileName' is already available in the 'opts' object, which is loaded
              // from sessionStorage and updated by the edit form.
              // No need to get it from previewsData as previewsData contains page-specific info.

              // Optional: Log the 'opts' object before sending to verify its content
              console.log("Opts object being sent to backend:", opts);
              console.log("JSON stringified opts:", JSON.stringify(opts));

              const modal = document.getElementById("myModal");

              fetch("/print_document", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(opts), // Use the 'opts' object with all print settings including fileName
              })
              .then((res) => {
                  if (!res.ok) {
                      return res.json().then(errData => {
                          const printErrMsg = `Print request failed. Status: ${res.status}. Backend Error: ${errData.error || 'Unknown error'}`;
                          console.error(printErrMsg, errData);
                          logError(printErrMsg, `PrintOptions: ${JSON.stringify(opts)}, BackendResponse: ${JSON.stringify(errData)}`);
                          // alert("Failed to send print job: " + (errData.error || "Please contact support."));
                          window.location.href = "/";
                          throw new Error('Print HTTP error');
                      }).catch(() => {
                          const printErrMsg = `Print request failed. Status: ${res.status}.`;
                          console.error(printErrMsg);
                          logError(printErrMsg, `PrintOptions: ${JSON.stringify(opts)}`);
                          // alert("Failed to send print job. Please contact support.");
                          window.location.href = "/";
                          throw new Error('Print HTTP error');
                      });
                  }
                  return res.json();
              })
              .then((data) => {
                  if (data.success) {
                      console.log("Print initiated successfully:", data.message);
                      if (modal) {
                          modal.style.display = "flex";
                      }
                      fetch('/api/record-transaction', {
                          method: 'POST',
                          headers: { 'Content-Type': 'application/json' },
                          body: JSON.stringify({ method: 'Direct Print (Free/No Payment)', amount: currentPrice })
                      }).then(res => res.json()).then(transData => {
                          if(transData.success) console.log("Direct print transaction recorded.");
                          else logError("Failed to record direct print transaction", JSON.stringify(transData));
                      }).catch(err => logError("Error recording direct print transaction", err.stack));

                      setTimeout(() => { window.location.href = "/"; }, 30000);
                  } else {
                      const printFailMsg = `Backend reported print failure: ${data.error}`;
                      console.error(printFailMsg);
                      logError(printFailMsg, `PrintOptions: ${JSON.stringify(opts)}, BackendResponse: ${JSON.stringify(data)}`);
                      alert("Printing failed: " + (data.error || "Unknown issue"));
                      window.location.href = "/";
                  }
              })
              .catch((error) => {
                  if (error.message !== 'Print HTTP error') {
                      const printCatchMsg = `Error during print request fetch: ${error.message}`;
                      console.error(printCatchMsg, error);
                      logError(printCatchMsg, `PrintOptions: ${JSON.stringify(opts)}, ErrorStack: ${error.stack}`);
                      alert("An error occurred while trying to print. Please check connection and try again.");
                      window.location.href = "/";
                  }
              });
          });

          function showModal(src) {
              const img = document.getElementById("modalImage");
              const isGrayscale = document.getElementById("editColorOption").value === "Grayscale";
              img.style.filter = isGrayscale ? "grayscale(100%)" : "";
              img.src = src;
              $("#imageModal").modal("show");
          }

          // Close button functionality for the new modal
          const myModalElement = document.getElementById("myModal");
          if (myModalElement) {
              document.querySelectorAll("#myModal .close").forEach((closeButton) => {
                  closeButton.onclick = () => {
                      myModalElement.style.display = "none";
                      window.location.href = "/"; // Redirect to home on close
                  };
              });
          }

      });
  </script>

    <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-body text-center p-0">
            <img
              id="modalImage"
              src=""
              class="img-fluid"
              style="max-height: 90vh"
            />
          </div>
        </div>
      </div>
    </div>
  </body>
</html>