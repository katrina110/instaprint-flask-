<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Result Page</title>
    <link
      rel="icon"
      href="{{ url_for('static', filename='images/logo.jpg') }}"
      type="image/x-icon"
    />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <link href="./../static/css/result.css" rel="stylesheet" />
    <link href="./../static/css/header.css" rel="stylesheet" />
    <style>
      /* define thumbnail dimensions for each size/orientation */
      .thumb-A4.portrait {
        width: 150px;
        height: 210px;
      }
      .thumb-A4.landscape {
        width: 210px;
        height: 150px;
      }
      .thumb-Short.portrait {
        width: 150px;
        height: 192px;
      }
      .thumb-Short.landscape {
        width: 192px;
        height: 150px;
      }
      .thumb-Long.portrait {
        width: 150px;
        height: 250px;
      }
      .thumb-Long.landscape {
        width: 250px;
        height: 150px;
      }
      .thumb-container {
        overflow: hidden;
        border: 1px solid #ccc;
        margin: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .thumb-container img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
      }
    </style>
  </head>
  <body>
    <header class="header">
      <img src="./../static/images/pup-logo.png" alt="logo" />
      <div class="center-text" style="background-color: white">
        INSTAPRINT
        <h6>PRINT PREVIEW RESULTS</h6>
      </div>
      <img src="./../static/images/cpe-logo.png" alt="logo" />
    </header>
    <div class="result-container">
      <div class="row">
        <div class="column left" style="margin-top: 3rem">
          <div id="printDetails" class="mb-4"></div>
          <div class="button">
            <button
              class="btn edit-btn mt-3"
              id="editButton"
              data-toggle="modal"
              data-target="#editModal"
            >
              Edit Print Options
            </button>
            <h3 class="mt-4" id="totalPrice">
              Total Price: ₱<span id="priceValue">0.00</span>
            </h3>
            <button class="btn btn-success mt-3" id="printButton">
              Proceed to Payment
            </button>
            <button
              class="btn edit-btn mt-3"
              onclick="window.location.href='/'"
            >
              Cancel
            </button>
          </div>
        </div>
        <div class="column right">
          <h2>Page Previews</h2>
          <div id="previewContainer" class="d-flex flex-wrap"></div>
          <h2 class="mt-5">Segmented Images and Price Breakdown</h2>
          <div id="segmentedContainer" class="d-flex flex-wrap"></div>
        </div>
      </div>
    </div>

    <!-- Edit Print Options Modal -->
    <div
      class="modal fade"
      id="editModal"
      tabindex="-1"
      aria-labelledby="editModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editModalLabel">Edit Print Options</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form id="editForm">
              <div class="form-group">
                <label for="editPageSelection">Pages to Print</label>
                <input
                  type="text"
                  class="form-control"
                  id="editPageSelection"
                  name="pageSelection"
                  placeholder="e.g. 1-2,4,7"
                  required
                />
              </div>
              <div class="form-group">
                <label for="editNumCopies">Number of Copies</label>
                <input
                  type="number"
                  class="form-control"
                  id="editNumCopies"
                  name="numCopies"
                  min="1"
                  required
                />
              </div>
              <div class="form-group">
                <label for="editOrientationOption">Orientation</label>
                <!-- **Changed** id to editOrientationOption -->
                <select
                  id="editOrientationOption"
                  name="orientationOption"
                  class="form-control"
                >
                  <option value="portrait">Portrait</option>
                  <option value="landscape">Landscape</option>
                  <option value="auto">Auto</option>
                </select>
              </div>
              <div class="form-group">
                <label for="editPageSize">Page Size</label>
                <select
                  class="form-control"
                  id="editPageSize"
                  name="pageSize"
                  required
                >
                  <option value="A4">A4</option>
                  <option value="Short">Short</option>
                  <option value="Long">Long</option>
                </select>
              </div>
              <div class="form-group">
                <label for="editColorOption">Color Option</label>
                <select
                  class="form-control"
                  id="editColorOption"
                  name="colorOption"
                  required
                >
                  <option value="Color">Color</option>
                  <option value="Grayscale">Grayscale</option>
                </select>
              </div>
              <button type="submit" class="btn btn-primary">
                Apply Changes
              </button>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        let previewsData = [];

        // Utility to map size/orientation → thumbnail class
        function thumbClass(size, orient) {
          const o = orient === "auto" ? "portrait" : orient;
          return `thumb-${size} ${o}`;
        }

        // Refreshes both the Selected-Options panel and the previews
        function refreshUI(options) {
          // 1) Selected options list
          document.getElementById("printDetails").innerHTML = `
            <h3>Selected Options:</h3>
            <ul>
              <li><strong>File:</strong> ${options.fileName}</li>
              <li><strong>Pages:</strong> ${options.pageSelection}</li>
              <li><strong>Copies:</strong> ${options.numCopies}</li>
              <li><strong>Orientation:</strong> ${options.orientationOption}</li>
              <li><strong>Page Size:</strong> ${options.pageSize}</li>
              <li><strong>Color:</strong> ${options.colorOption}</li>
            </ul>
          `;

          // 2) Apply to modal form defaults
          document.getElementById("editPageSelection").value =
            options.pageSelection || "";
          document.getElementById("editNumCopies").value =
            options.numCopies || 1;
          document.getElementById("editOrientationOption").value =
            options.orientationOption || "auto";
          document.getElementById("editPageSize").value =
            options.pageSize || "A4";
          document.getElementById("editColorOption").value =
            options.colorOption || "Color";

          // 3) Fetch previews + prices
          fetch("/preview_with_price", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(options),
          })
            .then((r) => r.json())
            .then((data) => {
              const pc = document.getElementById("priceValue");
              pc.textContent = data.totalPrice.toFixed(2);

              // Clear old
              const pC = document.getElementById("previewContainer");
              const sC = document.getElementById("segmentedContainer");
              pC.innerHTML = "";
              sC.innerHTML = "";

              // 4) Build new preview thumbnails
              data.pagePrices.forEach((p) => {
                const container = document.createElement("div");
                container.className =
                  "thumb-container " +
                  thumbClass(options.pageSize, options.orientationOption);

                // original preview
                const img = document.createElement("img");
                img.src = p.original;
                container.appendChild(img);
                pC.appendChild(container);

                // segmented view
                const seg = document.createElement("div");
                seg.className = "m-2 p-2 border";
                seg.innerHTML = `<p>Page ${p.page} (₱${p.price.toFixed(2)}):</p>
                  <img src="${p.processed}" style="max-width:200px;"/>`;
                sC.appendChild(seg);
              });

              previewsData = data.previews;
            })
            .catch(() =>
              alert("Failed to load preview data. Please try again.")
            );
        }

        // Load from sessionStorage on entry
        const opts = JSON.parse(sessionStorage.getItem("printOptions")) || {};
        refreshUI(opts);

        // Handle “Apply Changes” from the modal
        document.getElementById("editForm").addEventListener("submit", (e) => {
          e.preventDefault();
          // Collect updated values
          const updated = {
            fileName: opts.fileName,
            pageSelection: document.getElementById("editPageSelection").value,
            numCopies: parseInt(
              document.getElementById("editNumCopies").value,
              10
            ),
            orientationOption: document.getElementById("editOrientationOption")
              .value,
            pageSize: document.getElementById("editPageSize").value,
            colorOption: document.getElementById("editColorOption").value,
          };
          sessionStorage.setItem("printOptions", JSON.stringify(updated));
          refreshUI(updated);
          $("#editModal").modal("hide");
        });

        // Proceed to payment
        document
          .getElementById("printButton")
          .addEventListener("click", (ev) => {
            ev.preventDefault();
            if (
              !previewsData.length ||
              parseFloat(document.getElementById("priceValue").textContent) ===
                0
            ) {
              return alert(
                previewsData.length === 0
                  ? "Previews not ready yet."
                  : "Total price is ₱0. Cannot proceed."
              );
            }
            sessionStorage.setItem(
              "totalPrice",
              document.getElementById("priceValue").textContent
            );
            sessionStorage.setItem("previews", JSON.stringify(previewsData));
            window.location.href = "/payment-type";
          });
      });
    </script>
  </body>
</html>
