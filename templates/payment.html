<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Payment</title>
  <link rel="icon" href="{{ url_for('static', filename='images/logo.jpg') }}" type="image/x-icon" />
  <link href="{{ url_for('static', filename='css/header.css') }}" rel="stylesheet" />
  <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>

  <style>
    /* Basic layout styles */
    body, html {
      height: 100%;
      margin: 0;
      display: flex;
      flex-direction: column;
      font-family: "Inter", sans-serif; /* Use Inter font */
    }
    main {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      flex: 1;
      text-align: center;
      padding: 20px; /* Add some padding */
    }
    main h1, main h3, main p {
      margin: 10px 0;
    }

    /* Coin count display */
    #coin-count {
      font-size: 80px;
      color: #4CAF50; /* Green color for coin count */
      margin-top: 20px;
    }
    #coin-count span {
        font-size: 80px; /* Ensure span also has large font */
    }

    /* Cancel Button Styling */
    .btn-cancel {
      border-radius: 0.5rem; /* More rounded corners */
      border: none;
      background-color: #d32f2f; /* Red color for cancel */
      color: white;
      width: 250px; /* Slightly wider button */
      height: 50px; /* Taller button */
      font-size: 18px; /* Larger font size */
      cursor: pointer;
      margin-top: 30px; /* More space above button */
      transition: background-color 0.3s ease; /* Smooth transition for hover */
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Add subtle shadow */
    }
    .btn-cancel:hover:not(:disabled) {
        background-color: #c62828; /* Darker red on hover */
    }
    .btn-cancel:disabled {
      background-color: #9e9e9e; /* Gray when disabled */
      cursor: not-allowed;
      opacity: 0.7; /* Slightly less opaque when disabled */
      box-shadow: none; /* Remove shadow when disabled */
    }

    /* Modal Styling */
    .modal {
      /* Initially hide the modal */
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.6); /* Darker overlay */
      /* Use flexbox to center modal content when displayed */
      justify-content: center;
      align-items: center;
      padding: 20px; /* Add padding for smaller screens */
    }
    .modal-content {
      background-color: #fefefe;
      padding: 30px; /* More padding */
      border: 1px solid #b0b0b0; /* Slightly darker border */
      width: 90%; /* Make modal responsive */
      max-width: 400px; /* Max width for larger screens */
      border-radius: 15px;
      text-align: center; /* Center content inside modal */
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2); /* More prominent shadow */
      position: relative; /* Needed for absolute positioning of close button */
    }
    .close {
      color: #aaa;
      /* float: right;  Removed float */
      font-size: 32px; /* Larger close button */
      font-weight: bold;
      position: absolute; /* Position absolute relative to modal-content */
      top: 10px;
      right: 15px;
    }
    .close:hover, .close:focus {
      color: #777; /* Darker gray on hover */
      text-decoration: none;
      cursor: pointer;
    }

    /* Star Rating Styling */
    .star-rating {
      direction: rtl;
      display: inline-flex;
      margin-bottom: 20px; /* More space below stars */
      gap: 5px; /* Add space between stars */
    }
    .star-rating input {
      display: none;
    }
    .star-rating label {
      font-size: 2.5rem; /* Larger stars */
      color: #ddd;
      cursor: pointer;
      transition: color 0.2s ease; /* Smooth color transition */
    }
    .star-rating input:checked ~ label,
    .star-rating label:hover,
    .star-rating label:hover ~ label {
      color: gold;
    }

    /* Feedback QR Code and Text */
    .modal-content img {
        margin-top: 15px;
        width: 180px; /* Slightly larger QR code */
        height: 180px;
        border: 1px solid #eee; /* Subtle border around QR */
        border-radius: 5px; /* Rounded corners for QR */
    }
    .amount {
      font-size: 14px; /* Slightly smaller font */
      margin-top: 20px;
      color: #555; /* Darker gray */
      text-align: center;
      opacity: 0.9; /* Less transparent */
    }

    /* Responsive Adjustments */
    @media (max-width: 600px) {
      .modal-content {
        width: 95%;
        padding: 20px;
      }
      .btn-cancel {
          width: 100%; /* Full width on small screens */
          font-size: 16px;
      }
      .star-rating label {
          font-size: 2rem; /* Smaller stars on small screens */
      }
       #coin-count {
          font-size: 60px; /* Smaller coin count on small screens */
        }
        #coin-count span {
            font-size: 60px;
        }
    }
  </style>
</head>
<body>
  <header class="header">
    <img src="{{ url_for('static', filename='images/pup-logo.png') }}" alt="PUP Logo" />
    <div class="center-text" style="background-color: white;">INSTAPRINT <h6>COINS PAYMENT</h6></div>
    <img src="{{ url_for('static', filename='images/cpe-logo.png') }}" alt="CPE Logo" />
  </header>

  <main>
    <img src="{{ url_for('static', filename='images/coins.png') }}" alt="Coins Illustration" style="width: 50rem; max-width: 90%; margin-bottom: 30px;" />
    <h1>Payment Page</h1>
    <h3>Total Price: ₱<span id="priceValue">0.00</span></h3>
    <h3>Coins Inserted:</h3>
    <h3 id="coin-count">₱<span style="font-size: inherit;">0</span></h3> <button class="btn-cancel" id="cancelPayment">Cancel Payment</button>

    <div id="myModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Thank You for Using InstaPrint!</h2>
        <p>Your document is now being processed and will start to print soon.</p>
        <h3>Rate Your Experience:</h3>
        <div class="star-rating">
          <input type="radio" id="star5" name="rating" value="5"><label for="star5" title="5 stars">☆</label>
          <input type="radio" id="star4" name="rating" value="4"><label for="star4" title="4 stars">☆</label>
          <input type="radio" id="star3" name="rating" value="3"><label for="star3" title="3 stars">☆</label>
          <input type="radio" id="star2" name="rating" value="2"><label for="star2" title="2 stars">☆</label>
          <input type="radio" id="star1" name="rating" value="1"><label for="star1" title="1 star">☆</label>
        </div>
        <br>
        <h4>Give Us Your Feedback</h4>
        <img src="{{ url_for('static', filename='images/feedback_qr.png') }}" alt="Feedback QR Code" />
        <p class="amount"><i>Redirecting to home page after 30 seconds.</i></p>
      </div>
    </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
    // Initialize Socket.IO connection
    const socket = io();

    // Get necessary DOM elements
    const priceValueElement = document.getElementById("priceValue");
    const coinCountH3 = document.getElementById("coin-count");
    const coinCountSpan = coinCountH3 ? coinCountH3.querySelector("span") : null; // Safely get the span
    const modal = document.getElementById("myModal");
    const cancelBtn = document.getElementById("cancelPayment");

    // Retrieve total price and print options from sessionStorage
    const totalPrice = sessionStorage.getItem("totalPrice");
    const printOptions = JSON.parse(sessionStorage.getItem("printOptions"));

    function logError(message) {
      fetch('/log_activity', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message })
      }).catch(err => console.error("Failed to log activity:", err));
    }


    // Display total price or handle missing data
    if (totalPrice && !isNaN(parseFloat(totalPrice))) {
      priceValueElement.textContent = parseFloat(totalPrice).toFixed(2);

      // 1) Send the total price to the backend to set the price on the Arduino
      fetch("/set_price", { // <--- This fetch request
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ price: parseFloat(totalPrice) }), // Ensure price is a number
      })
      .then(response => {
          if (!response.ok) {
              // Handle HTTP errors
              console.error('Failed to set price:', response.status, response.statusText);
              // Optionally inform the user
              // alert("Failed to set price with the system. Please try again.");
              // window.location.href = "/manual-display-upload"; // Redirect on failure
          }
          return response.json(); // Parse JSON response
      })
      .then(data => {
          if (!data.success) {
               console.error('Backend reported failure setting price:', data.message);
               logError("Backend reported failure setting price: " + data.message);
               // Optionally inform the user
               // alert("Failed to set price with the system. Please try again.");
               // window.location.href = "/manual-display-upload"; // Redirect on failure
          } else {
               console.log('Price set successfully:', data.message);
          }
      })
      .catch((error) => {
        console.error("Error sending price to backend:", error);
        logError("Error sending price to backend: " + error.message);
      });


    } else {
      // If total price is missing or invalid, alert user and redirect
      alert("Total Price could not be loaded. Please go back and reselect your options.");
      window.location.href = "/manual-display-upload";
    }

      // WebSocket Listener: Update coin count display
      socket.on("update_coin_count", (data) => {
        const value = parseInt(data.count) || 0; // Ensure value is an integer, default to 0
        if (coinCountSpan) {
            coinCountSpan.textContent = value;
        }

        // Disable Cancel button when coin is inserted (value > 0)
        if (cancelBtn) {
          cancelBtn.disabled = value > 0;
        }

        // Check if inserted coins meet or exceed the total price
        // Ensure both values are numbers before comparison
        const currentPrice = parseFloat(priceValueElement.textContent) || 0;
        if (value >= currentPrice && printOptions) {
          console.log("Payment complete. Triggering print.");
          // Trigger the printing process on the backend
          fetch("/print_document", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(printOptions), // Send the stored print options
          })
          .then((res) => {
              if (!res.ok) {
                  // Handle HTTP errors for the print request
                  console.error('Print request failed:', res.status, res.statusText);
                  // Optionally show an error message to the user
                  alert("Failed to send print job. Please contact support.");
                  // Redirect or handle error appropriately
                  window.location.href = "/"; // Example: Redirect to home on print failure
                  throw new Error(`HTTP error! status: ${res.status}`); // Propagate error to catch block
              }
              return res.json(); // Parse JSON response
          })
          .then((data) => {
            if (data.success) {
              console.log("Print initiated successfully:", data.message);
              // Show the success modal ONLY on successful print initiation
              if (modal) {
                 modal.style.display = "flex"; // Use flex to center
              }
              // Redirect to home page after a delay
              setTimeout(() => {
                window.location.href = "/";
              }, 30000); // 30 seconds delay
            } else {
              console.error("Backend reported print failure:", data.error);
              logError("Backend reported print failure: " + data.error);
              // Optionally show an error message from the backend
              alert("Printing failed: " + data.error);
              // Redirect or handle error appropriately
              window.location.href = "/"; // Example: Redirect to home on print failure
            }
          })
          .catch((error) => {
            console.error("Error during print request:", error);
            logError("Error during print request: " + error.message);
            // Handle network errors or other exceptions during the fetch call
            alert("An error occurred while trying to print. Please check connection and try again.");
            window.location.href = "/"; // Example: Redirect to home on error
          });
        }
      });

      // WebSocket Listener: Handle coin count reset (e.g., by backend after printing)
      socket.on("coin_count_reset", () => {
        if (coinCountSpan) {
            coinCountSpan.textContent = "0";
        }
        // Re-enable Cancel button after reset
        if (cancelBtn) {
            cancelBtn.disabled = false;
        }
        console.log("Coin count reset received.");
      });

       // WebSocket Listener: Handle printer status updates
       // Note: The original code had a 'printer_status' listener in the first script block.
       // This consolidated version uses 'printer_status_update' from the backend monitor.
       socket.on("printer_status_update", (data) => {
           const statusEl = document.getElementById("printerStatus"); // Get the status element
           if (statusEl) {
               statusEl.textContent = data.status;
               console.log("Printer status updated:", data.status);
           }
       });

       // WebSocket Listener: Handle change dispensed message
       socket.on("change_dispensed", data => {
           const statusEl = document.getElementById("printerStatus"); // Get the status element
           if (statusEl) {
                statusEl.textContent = `Printing… returning ₱${data.amount} change`;
                console.log("Change dispensed:", data.amount);
           }
       });


      // Close modal functionality
      // The modal should only be closable after it's shown
      if (modal) {
          document.querySelectorAll(".close").forEach((closeButton) => {
            closeButton.onclick = () => {
              modal.style.display = "none";
              window.location.href = "/"; // Redirect to home page on modal close
            };
          });
      }


      // Add event listener to the Cancel Payment button
      if (cancelBtn) {
        cancelBtn.addEventListener('click', function() {
            console.log("Cancel payment button clicked.");
            // Send a POST request to the stop_coin_detection route on the backend
            fetch('/stop_coin_detection', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('Coin detection stopped:', data.message);
                // After successfully stopping detection, navigate back or to another page
                window.history.back(); // Navigate back to the previous page
            })
            .catch(error => {
                console.error('Error stopping coin detection:', error);
                logError("Error stopping coin detection: " + error.message);
                // Still navigate back even if there's an error, to avoid getting stuck
                window.history.back();
            });
        });
      }
    });
  </script>
</body>
</html>