<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Payment</title>
    <link
      rel="icon"
      href="{{ url_for('static', filename='images/logo.jpg') }}"
      type="image/x-icon"
    />
    <link href="./../static/css/header.css" rel="stylesheet" />
    <style>
      body,
      html {
        height: 100%;
        margin: 0;
        display: flex;
        flex-direction: column;
      }
      main {
        display: flex;
        flex: 1;
        align-items: center;
        padding: 20px;
        justify-content: space-around; /* Distribute space between sections */
      }
      .payment-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .payment-section img {
        max-width: 300px;
        height: auto;
        margin: 75px auto 20px auto; /* Adjust top/bottom margin and center horizontally */
        filter: none; /* Default: no filter */
      }
      .payment-section.disabled img {
        filter: grayscale(100%);
      }
      .right-section .payment-section img {
        /* Target GCash logo */
        max-width: 150px;
        margin: 25px auto 20px auto; /* Adjust top/bottom margin and center horizontally */
      }
      main h1 {
        margin: 10px 0;
        text-align: center;
      }
      main p {
        margin: 10px 0;
        text-align: center;
        font-size: 1.1rem;
      }
      .amount,
      .amount-value {
        font-size: 15px;
        margin-top: 15px;
        color: gray;
        text-align: center; /* Center the amount text */
        opacity: 0.75;
      }
      .btn-coins {
        border-radius: 1.5rem;
        border: none;
        background-color: #700000;
        color: white;
        width: 200px;
        height: 50px;
        margin-top: 20px;
        cursor: pointer;
        font-weight: bold;
        font-size: 15px;
        filter: none; /* Default: no filter */
      }
      .btn-gcash {
        border-radius: 1.5rem;
        border: none;
        background-color: #700000;
        color: white;
        width: 175px;
        height: 50px;
        margin-top: 20px;
        cursor: pointer;
        font-weight: bold;
        font-size: 15px;
      }
      .btn-gcash.disabled {
        background-color: gray;
        cursor: not-allowed;
        filter: grayscale(100%);
      }
      .left-section {
        padding-left: 100px; /* Add some spacing between the sections */
      }
      .right-section {
        padding-right: 100px; /* Add some spacing between the sections */
      }
    </style>
  </head>
  <body>
    <header class="header">
      <img src="./../static/images/pup-logo.png" alt="sample" />
      <div class="center-text" style="background-color: white">
        INSTAPRINT
        <h6>SELECT PAYMENT</h6>
      </div>
      <img src="./../static/images/cpe-logo.png" alt="sample" />
    </header>
    <main>
      <div
        class="payment-section"
        style="margin-bottom: 40px; text-align: center"
      >
        <h2>Feed Paper to Printer</h2>
        <p style="max-width: 500px; margin: 10px auto; font-size: 1rem">
          Before proceeding with payment, ensure the printer is loaded with
          paper. Press and hold the button below to feed a sheet into the
          printer.
        </p>
        <button
          id="spinMotorButton"
          style="
            padding: 12px 30px;
            font-size: 16px;
            background-color: #800000;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 10px;
          "
        >
          Feed Paper (Spin Motor)
        </button>
      </div>
      <div class="left-section payment-section">
        <h1>Pay with Coins</h1>
        <img
          src="./../static/images/coins.png"
          alt="Pay with Coins"
          style="max-width: 400px; height: auto; margin: 75px"
        />
        <p>
          It is recommended to choose this type of payment<br />for amounts
          <strong>₱19.00 and below</strong>.
        </p>
        <button class="btn-coins" id="coinsButton">Choose this Payment</button>
        <p class="amount">
          <i
            >Amount to pay: <span class="amount-value" id="coinsAmount"></span
          ></i>
        </p>
      </div>
      <div class="right-section payment-section" id="gcashSection">
        <h1>Pay with GCash</h1>
        <img
          id="gcashLogo"
          src="./../static/images/gcash-logo.png"
          alt="Pay with GCash"
          style="max-width: 150px; height: auto; margin: 25px"
        />
        <p>
          This payment option is only available <br />for amounts
          <strong>₱20.00 and up</strong>.
        </p>
        <button class="btn-gcash" id="gcashButton">Pay with GCash</button>
        <p class="amount">
          <i
            >Amount to pay: <span class="amount-value" id="gcashAmount"></span
          ></i>
        </p>
      </div>
    </main>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const totalPrice = parseFloat(sessionStorage.getItem("totalPrice")) || 0.0; // Ensure totalPrice is a number
        const gcashSection = document.getElementById("gcashSection");
        const gcashLogo = document.getElementById("gcashLogo");
        const gcashButton = document.getElementById("gcashButton");
        const coinsAmountSpan = document.getElementById("coinsAmount");
        const gcashAmountSpan = document.getElementById("gcashAmount");
        const coinsButtonElement = document.getElementById("coinsButton");

        if (totalPrice < 20.0) {
          gcashSection.classList.add("disabled");
          gcashLogo.style.filter = "grayscale(100%)";
          gcashButton.classList.add("disabled");
          gcashButton.disabled = true;
        } else {
          gcashSection.classList.remove("disabled");
          gcashLogo.style.filter = "none";
          gcashButton.classList.remove("disabled");
          gcashButton.disabled = false;
        }

        if (!isNaN(totalPrice)) {
          coinsAmountSpan.textContent = "₱" + totalPrice.toFixed(2);
          gcashAmountSpan.textContent = "₱" + totalPrice.toFixed(2);
        } else {
          coinsAmountSpan.textContent = "₱0.00";
          gcashAmountSpan.textContent = "₱0.00";
        }

        // ***** MODIFIED SECTION FOR COINS BUTTON *****
        coinsButtonElement.addEventListener("click", () => {
          // 1. Navigate to the payment page immediately.
          //    The /payment route in app.py expects a 'price' query parameter.
          window.location.href = `/payment?price=${totalPrice.toFixed(2)}`;

          // 2. Attempt to record the transaction in the background.
          //    Note: The browser might cancel this fetch request if the page unloads too quickly.
          //    Using the corrected endpoint /api/record-transaction from your app.py
          fetch("/api/record-transaction", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ method: "Coinslot", amount: totalPrice }),
          })
          .then(response => {
            if (!response.ok) {
              // Log error if response is not OK, but don't block navigation
              console.error("Background transaction record failed with status:", response.status);
              return response.json().then(err => Promise.reject(err)); // Propagate error for catch block
            }
            return response.json();
          })
          .then(data => {
            if (data.success) {
              console.log("Transaction recorded successfully (background).");
            } else {
              console.error("Failed to record transaction (background):", data.message);
            }
          })
          .catch(error => {
            // Log any errors from the fetch request
            console.error("Error sending transaction record (background):", error);
          });
        });
        // ***** END OF MODIFIED SECTION *****

        if (!gcashButton.disabled) {
          gcashButton.addEventListener("click", () => {
            // For GCash, we maintain the original sequence for now as per your specific request for coins.
            // If you want this changed too, the logic would be similar to the coins button.
            // Using the corrected endpoint /api/record-transaction
            fetch("/api/record-transaction", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ method: "GCash", amount: totalPrice }),
            })
            .then(response => response.json()) // Assuming success, add error handling if needed
            .then(() => {
                window.location.href = "/gcash-payment";
            })
            .catch(error => {
                console.error("Error recording GCash transaction or navigating:", error);
                // Optionally, still navigate or show an error to the user
                // window.location.href = "/gcash-payment"; // Or handle error display
            });
          });
        }
      });
    </script>
    <script>
      const spinBtn = document.getElementById("spinMotorButton");

      spinBtn.addEventListener("mousedown", () => {
        fetch("/spin-motor/start", { method: "POST" });
      });

      spinBtn.addEventListener("mouseup", () => {
        fetch("/spin-motor/stop", { method: "POST" });
      });

      spinBtn.addEventListener("mouseleave", () => {
        // Stop motor if mouse leaves button while pressed
        fetch("/spin-motor/stop", { method: "POST" });
      });

      spinBtn.addEventListener("touchstart", (e) => {
        e.preventDefault(); // Prevent potential multi-touch issues or scrolling
        fetch("/spin-motor/start", { method: "POST" });
      });

      spinBtn.addEventListener("touchend", (e) => {
        e.preventDefault();
        fetch("/spin-motor/stop", { method: "POST" });
      });
    </script>

    <div style="text-align: center; margin-bottom: 30px">
      <button
        onclick="history.back()"
        style="
          margin-bottom: 20px;
          padding: 10px 20px;
          font-size: 16px;
          background-color: #800000;
          color: white;
          border: none;
          border-radius: 8px;
          cursor: pointer;
        "
      >
        Return
      </button>
    </div>
  </body>
</html>