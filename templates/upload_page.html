<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Wireless File Transfer</title>
    <link
      href="{{ url_for('static', filename='images/logo.jpg') }}"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link href="{{ url_for('static', filename='css/upload_page.css') }}" rel="stylesheet" />
    <link href="{{ url_for('static', filename='css/header.css') }}" rel="stylesheet" />
    <style>
      body {
        overflow: hidden;
      }
      body.modal-open {
          overflow: hidden !important;
      }
      .zoom-overlay {
        display: none;
        position: fixed;
        z-index: 9999;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: rgba(0, 0, 0, 0.8);
        justify-content: center;
        align-items: center;
      }
      .zoom-overlay img {
        max-width: 90%;
        max-height: 90%;
      }
      .close-zoom {
        position: absolute;
        top: 20px;
        right: 30px;
        font-size: 30px;
        color: white;
        cursor: pointer;
        font-weight: bold;
      }
      .centered-text {
        text-align: center;
      }
      .btn-center {
        display: flex;
        justify-content: center;
        margin-top: 15px;
        gap: 10px;
      }

      .sticky-button {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #700000;
        color: white;
        border: none;
        border-radius: 50px;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        z-index: 1000;
      }

      .modal-body-video {
        text-align: center;
      }

      .modal-body-video iframe {
        width: 100%;
        height: 400px;
      }

      .step {
        display: none;
      }
      .step.active {
        display: block;
        animation: fadeIn 0.5s ease-in-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .stepper {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 50px;
        gap: 60px;
      }
      .stepper .step-indicator {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #ddd;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #333;
        font-size: 18px;
        position: relative;
        transition: background 0.3s, color 0.3s;
      }
      .stepper .step-indicator.active {
        background: #700000;
        color: white;
      }
      .stepper .step-indicator:not(:last-child)::after {
        content: "";
        position: absolute;
        width: 60px;
        height: 4px;
        background: #ddd;
        top: 50%;
        left: 100%;
        margin-left: 10px;
      }
      .stepper .step-indicator.active:not(:last-child)::after {
        background: #700000;
      }

      .preview-container {
        min-height: 200px; 
        overflow-y: auto; 
        border: 1px solid #ccc;
        padding: 10px;
        width: 100%; 
      }
      .preview-page {
        margin-bottom: 10px;
        border: 1px solid #ddd;
        background-color: #f9f9f9; 
      }
      .preview-page img {
        max-width: 100%;
        max-height: 180px; 
        object-fit: contain;
        height: auto;
        display: block;
        margin: auto;
      }
      .preview-modal-body { 
        display: flex;
        flex-direction: column; 
        padding: 20px; 
        gap: 20px; 
      }
      @media (min-width: 768px) { 
        .preview-modal-body { 
          flex-direction: row;
        }
      }

      .form-section {
        flex: 1;
        min-width: 250px; 
      }
      .preview-section {
        flex: 1;
        min-width: 250px; 
        display: flex; 
        flex-direction: column; 
      }
       .preview-section .preview-container {
        flex-grow: 1; 
      }
      #printOptionsModal .preview-section h6 {
        font-size: 0.85rem; 
        margin-bottom: 0.5rem; 
      }


      #preloader {
        display: none; 
        position: fixed;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        z-index: 9999;
        top: 0;
        left: 0;
        justify-content: center; 
        align-items: center; 
      }
      #preloader.active {
        display: flex;
      }

      .spinner {
        border: 6px solid #f3f3f3;
        border-top: 6px solid #700000;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .btn-group-custom .btn { 
        display: flex;
        gap: 10px;
        margin-top: 10px;
        padding: 10px;
      }

      .qr-code-css {
        width: 120px;
        height: 120px;
        margin: 0 auto;
        background-image: url("{{ url_for('static', filename='images/toffeshare.png') }}");
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        cursor: pointer;
      }

      #pageSelection:disabled {
        background-color: #f0f0f0;
        color: #888;
      }

      .btn-theme-red {
        color: #fff;
        background-color: #700000;
        border-color: #700000;
      }

      .btn-theme-red:hover {
        color: #fff;
        background-color: #5a0000;
        border-color: #5a0000;
      }

      .btn-theme-red:focus,
      .btn-theme-red.focus {
        box-shadow: 0 0 0 0.2rem rgba(112, 0, 0, 0.5);
      }

      .btn-theme-red.disabled,
      .btn-theme-red:disabled {
        color: #fff;
        background-color: #700000;
        border-color: #700000;
        opacity: 0.65;
      }

      #pageSelectionContainer button {
        width: 48px;
        height: 48px;
        margin: 4px;
        padding: 0;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 16px;
        display: flex; 
        align-items: center;
        justify-content: center;
      }
      #pageSelectionContainer button.selected {
        background-color: #700000;
        color: #fff;
        border-color: #600;
      }

      #toffeeshareModal iframe {
          width: 100%;
          height: 80vh; 
          border: none; 
      }

      #recentDownloadsContainer {
        display: flex; 
        flex-wrap: nowrap; 
        overflow-x: auto; 
        overflow-y: hidden; 
        padding: 15px 15px; 
        gap: 15px; 
        border: 1px solid #ddd;
        background-color: #f9f9f9;
        min-height: 180px; 
        border-radius: 8px; 
        max-width: 500px; 
        margin-left: auto;
        margin-right: auto;
      }

      #recentDownloadsContainer .list-group-item {
        flex: 0 0 auto; 
        width: 120px; 
        height: auto; 
        display: flex;
        flex-direction: column; 
        align-items: center; 
        text-align: center;
        padding: 10px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        background-color: #fff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        cursor: pointer;
      }
      #recentDownloadsContainer .list-group-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      }
      #recentDownloadsContainer .list-group-item.active {
        background-color: #700000;
        color: white;
        border-color: #5a0000;
        box-shadow: 0 2px 5px rgba(112,0,0,0.3);
      }
      #recentDownloadsContainer .list-group-item.active .download-filename,
      #recentDownloadsContainer .list-group-item.active small {
        color: #f0f0f0 !important; 
      }

      #recentDownloadsContainer .list-group-item .preview-image-container {
        width: 80px; 
        height: 80px; 
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden; 
        border-radius: 4px;
        background-color: #f0f0f0; 
      }

      #recentDownloadsContainer .list-group-item img.file-preview {
        max-width: 100%;
        max-height: 100%;
        object-fit: cover; 
      }
      #recentDownloadsContainer .list-group-item img.file-icon {
        max-width: 60%; 
        max-height: 60%;
        object-fit: contain;
      }
       #recentDownloadsContainer .list-group-item .no-preview-placeholder {
        font-size: 10px;
        color: #888;
        text-align: center;
      }


      #recentDownloadsContainer .list-group-item .download-filename {
        font-weight: 500;
        font-size: 0.8rem; 
        color: #333;
        width: 100%; 
        white-space: nowrap; 
        overflow: hidden; 
        text-overflow: ellipsis; 
        margin-bottom: 2px;
      }
      #recentDownloadsContainer .list-group-item small {
        font-size: 0.7rem; 
        color: #777;
      }
      

      .container.mt-4 { 
        padding-top: 8rem; 
        padding-bottom: 4rem; 
      }

      #termsModal .modal-body {
        display: block; 
        column-count: auto !important;
        column-gap: normal !important;
        column-width: auto !important;
        -webkit-column-count: auto !important; 
        -moz-column-count: auto !important;    
      }

      #termsModal .modal-body > * { 
        display: block;    
        width: 100%;       
        float: none;       
        margin-left: 0;    
        margin-right: 0;
      }

      #printOptionsModal .modal-content {
        max-height: 90vh; 
        display: flex;
        flex-direction: column;
        height: 100%; 
      }

      #printOptionsModal .preview-modal-body { 
        flex-grow: 1; 
        overflow-y: hidden; 
        padding: 15px; 
      }
    </style>
  </head>
  <body>
    <div id="preloader"> <div class="spinner"></div>
    </div>

    <div
      class="modal fade"
      id="termsModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="termsModalLabel"
      aria-hidden="true"
      data-backdrop="static"
      data-keyboard="false"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header" style="background-color: #700000; color: white;">
            <h5 class="modal-title" id="termsModalLabel">
              Terms and Agreements
            </h5>
          </div>
          <div class="modal-body">
            <p style="font-size: 15px; margin-bottom: 1rem;">
              We value your privacy and are committed to protecting your data.
              By proceeding, you agree to the following:
            </p>
            <h5 style="margin-bottom: 0.5rem;">Data Use:</h5>
            <ul style="list-style-type: none; font-size: 15px; padding-left: 0; margin-bottom: 1rem;">
              <li>
                ✅ Your files will only be accessed for the purpose of
                providing the requested service or functionality.
              </li>
              <li>
                ✅ We do not store or share your files with third parties
                unless explicitly authorized by you.
              </li>
            </ul>
            <h5 style="margin-bottom: 0.5rem;">Permissions:</h5>
            <ul style="list-style-type: none; font-size: 15px; padding-left: 0; margin-bottom: 1rem;">
              <li>
                ✅ This application requires access to your files to enable
                the uploading of documents. This feature allows you to
                securely select files from your device and send them to the
                printer for printing.
              </li>
            </ul>
            <h5 style="margin-bottom: 0.5rem;">Security Measures:</h5>
            <ul style="list-style-type: none; font-size: 15px; padding-left: 0; margin-bottom: 1rem;">
              <li>
                ✅ All accessed data will be handled securely, adhering to
                industry-standard encryption and privacy practices.
              </li>
            </ul>
            <p style="font-size: 15px; margin-top: 1rem; margin-bottom: 0.5rem;">
              Do you agree to allow this application to access your files for
              the specified purpose?
            </p>
            <div class="form-group">
              <label for="acceptTerms">
                <input style="font-size: 15px" id="acceptTerms" type="checkbox" /> I agree to the terms
                and conditions.
              </label>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="window.history.back();"
            >
              Decline
            </button>
            <button
              type="button"
              class="btn btn-secondary" id="acceptTermsButton"
              disabled
            >
              Accept
            </button>
          </div>
        </div>
      </div>
    </div>

    <header class="header">
      <img alt="PUP Logo" src="{{ url_for('static', filename='images/pup-logo.png') }}" />
      <div class="center-text">
        INSTAPRINT
        <h6>WIRELESS FILE TRANSFER</h6>
      </div>
      <img alt="CPE Logo" src="{{ url_for('static', filename='images/cpe-logo.png') }}" />
    </header>

    <div class="container mt-4"> <div class="stepper">
        <div class="step-indicator active" id="step1-indicator">1</div>
        <div class="step-indicator" id="step2-indicator">2</div>
        <div class="step-indicator" id="step3-indicator">3</div>
      </div>

      <div class="step active" id="step1">
        <div class="centered-text">
          <h2>Step 1: Go to ToffeeShare</h2>
          <p>Use the QR code or type the link below:</p>
          <div class="qr-code-css" onclick="openZoom()"></div>
          <br />
          <b>https://toffeeshare.com/</b>
        </div>
        <div class="zoom-overlay" id="zoomOverlay" onclick="closeZoom()">
          <span class="close-zoom" onclick="closeZoom()">×</span>
          <img alt="Zoomed QR Code" src="{{ url_for('static', filename='images/toffeshare.png') }}" />
        </div>
        <div class="btn-center">
          <button class="btn btn-secondary" onclick="window.location.href='/'">
            Cancel
          </button>
          <button class="btn btn-primary next-btn">Next</button>
        </div>
      </div>

      <div class="step" id="step2">
        <div class="centered-text">
          <h2>Step 2: Upload your file using ToffeeShare</h2>
          <p style="margin-bottom: 20px">
            Use the <b>link below</b> to directly transfer files from your
            device to this kiosk. 
            <br>Simply click <b>'share to nearby PC'</b> on
            your device and <b>scan the QR code</b> to share your file.
          </p>
          <div class="btn-center">
            <a
              class="btn btn-primary" style="margin-top: 15px; margin-bottom: 10px; background-color: #BE7C2B"
              href="{{ toffee_share_link if toffee_share_link else 'https://toffeeshare.com/nearby' }}" id="openToffeeShareModal"
              >Open ToffeeShare</a
            >
          </div>
        </div>
        <div class="btn-center">
          <button class="btn btn-light prev-btn" style="background-color: #DAA520; color: #ffffff">Previous</button> <button class="btn btn-primary next-btn">Next</button>
          <button class="btn btn-secondary" onclick="window.location.href='/'">
            Cancel
          </button>
        </div>
      </div>

      <div class="step" id="step3">
        <div class="centered-text">
          <h2>Step 3: Select your File</h2>
          <p>Choose your file to be printed below.</p>
          <div id="recentDownloadsContainer" class="mb-3">
            <p id="downloadsLoadingMsg" class="text-center w-100">Loading recent downloads...</p>
          </div>
          <div id="selectedDownloadInfo" style="display: none; margin-bottom: 15px;">
            <p><strong>Selected:</strong> <span id="selectedDownloadName">N/A</span></p>
          </div>
        </div>
        <div class="btn-center">
          <button class="btn btn-light prev-btn" id="step3PrevBtn" style="background-color: #DAA520; color: #ffffff"> Previous
          </button>
          <button class="btn btn-secondary" onclick="window.location.href='/'">
            Cancel
          </button>
        </div>
      </div>

      <button
        class="sticky-button"
        data-target="#videoDemoModal"
        data-toggle="modal"
      >
        Video Demo
      </button>

      <div class="modal fade" id="videoDemoModal" role="dialog" tabindex="-1">
        <div class="modal-dialog modal-lg" role="document">
          <div class="modal-content">
            <div class="modal-header" style="background-color: #700000; color: white;">
              <h5 class="modal-title">Website Usage Demo</h5>
              <button
                aria-label="Close"
                class="close"
                data-dismiss="modal"
                type="button"
                style="color: white;"
              >
                <span aria-hidden="true">×</span>
              </button>
            </div>
            <div class="modal-body modal-body-video">
              <iframe
                allowfullscreen=""
                frameborder="0"
                src="https://www.youtube.com/embed/dQw4w9WgXcQ"  
                title="YouTube video player" 
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
              ></iframe>
            </div>
            <div class="modal-footer">
              <button
                class="btn btn-secondary"
                data-dismiss="modal"
                type="button"
              >
                Close
              </button>
            </div>
          </div>
        </div>
      </div>
    </div> 
    <div class="modal fade" id="printOptionsModal" tabindex="-1" role="dialog" aria-labelledby="printOptionsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered" role="document"> 
        <div class="modal-content">
          <div class="modal-header" style="background-color: #700000; color: white;">
            <h5 class="modal-title" id="printOptionsModalLabel">Print Options</h5>
          </div>
          <div class="preview-modal-body"> 
            <div class="form-section">
              <div class="form-group">
                <label>Pages to Print</label>
                <div
                  id="pageSelectionContainer"
                  class="d-flex flex-wrap mb-2"
                ></div>
                <input type="hidden" id="pageSelection" /> <small class="form-text text-muted">
                  Tap page numbers to select/deselect. All pages selected by default.
                </small>
              </div>

              <div class="form-group">
                <label for="pageSize">Page Size:</label>
                <input type="text" class="form-control" id="pageSize" value="Short" readonly>
              </div>

              <div class="form-group">
                <label for="numCopies">Number of Copies</label>
                <input
                  class="form-control"
                  id="numCopies"
                  min="1"
                  type="number"
                  value="1"
                />
              </div>
              <div class="form-group">
                <label for="orientationOption">Orientation</label>
                <select class="form-control" id="orientationOption">
                  <option value="auto">Auto</option>
                  <option value="portrait">Portrait</option>
                  <option value="landscape">Landscape</option>
                </select>
              </div>

              <div class="form-group">
                <label for="colorOption">Color Option</label>
                <select class="form-control" id="colorOption">
                  <option value="Color">Color</option>
                  <option value="Grayscale">Grayscale</option>
                </select>
              </div>
            </div>
            <div class="preview-section">
              <h6>File: <span id="printFileName">N/A</span></h6>
              <h6>Total Pages in Document: <span id="totalPages">N/A</span></h6>
              <h6>Preview of Selected Pages:</h6>
              <div class="preview-container" id="previewContainer">
                <p class="text-center">Select options to generate preview.</p>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              class="btn btn-secondary"
              data-dismiss="modal"
              id="closeModalBtn"
            >
              Cancel
            </button>
            <button class="btn btn-primary" id="continueBtn">Continue</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="toffeeshareModal" tabindex="-1" role="dialog" aria-labelledby="toffeeshareModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
      <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content" style="max-height: 100vh;"> <div class="modal-header" style="background-color: #700000; color: white;">
            <h5 class="modal-title" id="toffeeshareModalLabel">ToffeeShare</h5>
          </div>
          <div class="modal-body p-0" style="overflow: hidden;">
            <iframe id="toffeeshareIframe" src="" frameborder="0" style="width: 100%; height: 60vh; display: block;" scrolling="no"></iframe>
          </div>
           <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script>
      $(document).ready(function () {
        let previewTimeout;
        let totalPagesInDocument = 0;
        let currentUploadedFileName = "";
        let originalSelectedDownloadName = "";

        const downloadsLoadingMsg = $("#downloadsLoadingMsg");
        const recentDownloadsContainer = $("#recentDownloadsContainer");
        const selectedDownloadInfo = $("#selectedDownloadInfo");
        const selectedDownloadNameSpan = $("#selectedDownloadName");
        const prevStepBtnStep3 = document.getElementById("step3PrevBtn");
        const preloader = $("#preloader");

        // ========== FUNCTION TO FETCH AND DISPLAY RECENT DOWNLOADS ==========
        function fetchAndDisplayRecentDownloads() {
          recentDownloadsContainer.empty(); 
          downloadsLoadingMsg.text("Loading recent downloads...").show(); 
          if (recentDownloadsContainer.find('#downloadsLoadingMsg').length === 0) {
            recentDownloadsContainer.append(downloadsLoadingMsg); 
          }
          selectedDownloadInfo.hide();

          $.ajax({
            url: "{{ url_for('list_recent_downloads') }}",
            method: "GET",
            dataType: "json",
            success: function(response) {
              downloadsLoadingMsg.hide(); 
              recentDownloadsContainer.empty(); 

              if (response.error) {
                recentDownloadsContainer.html(`<p class="text-danger text-center w-100">Error: ${response.error}</p>`);
                return;
              }
              
              let filesDisplayed = 0; // Counter for displayed files

              if (response.files && response.files.length > 0) {
                const clientSideAllowedExtensions = ['.pdf', '.docx', '.jpg', '.png']; 

                response.files.forEach(function(file) {
                  const fileName = file.filename || "";
                  const fileExtension = "." + fileName.split('.').pop().toLowerCase();
                  
                  if (!clientSideAllowedExtensions.includes(fileExtension)) {
                    return; 
                  }

                  filesDisplayed++; 

                  const isSvgDataUrl = file.preview_url && file.preview_url.startsWith('data:image/svg+xml');
                  
                  let previewImageHtml;
                  if (isSvgDataUrl) {
                    previewImageHtml = `<img src="${file.preview_url}" alt="icon" class="file-icon">`;
                  } else if (file.preview_url) {
                    previewImageHtml = `<img src="${file.preview_url}" alt="preview" class="file-preview">`;
                  } else {
                    previewImageHtml = `<span class="no-preview-placeholder">No Preview</span>`;
                  }

                  const fileItem = $(`
                    <div class="list-group-item">
                      <div class="preview-image-container">
                        ${previewImageHtml}
                      </div>
                      <span class="download-filename" title="${fileName}">${fileName}</span>
                      <small class="text-muted">${file.mtime_readable}</small>
                    </div>
                  `);
                  fileItem.data("filename", fileName);
                  recentDownloadsContainer.append(fileItem);
                });
              }
              
              if (filesDisplayed === 0 && !(response.error)) { 
                recentDownloadsContainer.html("<p class='text-center w-100'>No files to be printed here.</p>");
              }

            },
            error: function(xhr, status, error) {
              downloadsLoadingMsg.hide();
              recentDownloadsContainer.empty(); 
              console.error("Failed to fetch recent downloads. Status:", status, "Error:", error);
              recentDownloadsContainer.html('<p class="text-danger text-center w-100">Failed to load recent downloads. Please try again.</p>');
            }
          });
        }

        // ========== CLICK HANDLER FOR DOWNLOADED FILE ITEMS ==========
        recentDownloadsContainer.on("click", ".list-group-item", function() {
          const selectedFilename = $(this).data("filename");
          originalSelectedDownloadName = selectedFilename;

          recentDownloadsContainer.find(".list-group-item").removeClass("active");
          $(this).addClass("active");
          selectedDownloadNameSpan.text(selectedFilename);
          selectedDownloadInfo.show();

          preloader.addClass("active");

          $.ajax({
            url: "{{ url_for('process_downloaded_file') }}",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({ selected_filename: selectedFilename }),
            success: function(response) {
              currentUploadedFileName = response.fileName;
              totalPagesInDocument = response.totalPages;
              buildPagePicker(totalPagesInDocument);
              $("#printFileName").text(currentUploadedFileName);
              $("#totalPages").text(totalPagesInDocument);
              // MODIFIED: Added backdrop: 'static' and keyboard: false to prevent dismissal
              $("#printOptionsModal").modal({ backdrop: 'static', keyboard: false }).modal("show");
            },
            error: function(xhr, status, error) {
              console.error("Processing selected download failed. Status:", status, "Error:", error);
              let errorMessage = "Failed to process selected file. Please try again.";
              if (xhr.responseJSON && xhr.responseJSON.error) {
                errorMessage = xhr.responseJSON.error;
              } else if (xhr.responseText) {
                  errorMessage = `Failed to process: ${xhr.responseText.substring(0,100)}`;
              }
              alert(errorMessage); 
              selectedDownloadInfo.hide();
              recentDownloadsContainer.find(".list-group-item").removeClass("active");
            },
            complete: function() {
              preloader.removeClass("active");
            }
          });
        });

        // ========== STEP NAVIGATION & TERMS ==========
        let currentStep = 1;
        function showStep(step) {
          currentStep = step;
          $(".step").removeClass("active");
          $("#step" + step).addClass("active");
          $(".step-indicator").removeClass("active");
          $("#step" + step + "-indicator").addClass("active");

          if (step === 3) {
            fetchAndDisplayRecentDownloads();
            if (prevStepBtnStep3) prevStepBtnStep3.disabled = false;
          } else {
            if (prevStepBtnStep3) prevStepBtnStep3.disabled = false;
          }
        }

        $(".next-btn").click(() => {
          if (currentStep < 3) showStep(currentStep + 1);
        });
        $(".prev-btn").click(function() {
            if ($(this).attr('id') === 'step3PrevBtn') {
                 if (currentStep === 3) showStep(2);
            } else {
                 if (currentStep > 1) showStep(currentStep - 1);
            }
        });
        
        $("#termsModal").modal({ backdrop: "static", keyboard: false }).modal("show");
        

        $("#acceptTerms").change(function () {
          $("#acceptTermsButton")
            .prop("disabled", !this.checked)
            .toggleClass("btn-secondary", !this.checked)
            .toggleClass("btn-theme-red", this.checked);
        });

        $("#acceptTermsButton").click(function () {
          if (!this.disabled) {
             localStorage.setItem("termsAcceptedInstaprint", "true"); 
             $("#termsModal").modal("hide");
          }
        });

        // ========== PAGE PICKER & PREVIEW ==========
        function buildPagePicker(numTotalPages) {
          totalPagesInDocument = numTotalPages;
          const container = $("#pageSelectionContainer").empty();
          if (numTotalPages === 0) {
              container.append("<p>No pages in document.</p>");
              $("#pageSelection").val("");
              return;
          }
          for (let i = 1; i <= numTotalPages; i++) {
            $("<button>")
              .attr("type", "button")
              .text(i)
              .addClass("btn btn-outline-secondary")
              .on("click", function () {
                $(this).toggleClass("selected btn-outline-secondary btn-theme-red");
                updatePageSelection();
              })
              .appendTo(container);
          }
          container.find("button").addClass("selected btn-theme-red").removeClass("btn-outline-secondary");
          updatePageSelection();
        }

        function updatePageSelection() {
          const selectedPageNumbers = $("#pageSelectionContainer button.selected")
            .map((_, btn) => $(btn).text())
            .get()
            .map(Number)
            .sort((a, b) => a - b);

          $("#pageSelection").val(selectedPageNumbers.join(","));

          if (selectedPageNumbers.length > 0) {
            schedulePreview();
          } else {
             $("#previewContainer").html("<p class='text-center'>No pages selected for preview.</p>");
             clearTimeout(previewTimeout);
          }
        }

        function schedulePreview() {
          clearTimeout(previewTimeout);
          previewTimeout = setTimeout(updatePreview, 300);
        }

        function updatePreview() {
          if (!$("#pageSelection").val() || totalPagesInDocument === 0) {
            $("#previewContainer").html("<p class='text-center'>No pages selected or document is empty.</p>");
            return;
          }
          const data = {
            pageSelection: $("#pageSelection").val(),
            numCopies: $("#numCopies").val(),
            pageSize: $("#pageSize").val(),
            colorOption: $("#colorOption").val(),
            orientationOption: $("#orientationOption").val() || "auto",
          };
          const previewCont = $("#previewContainer").html("<p class='text-center'>Loading preview…</p>");
          preloader.addClass("active");

          $.ajax({
            url: "{{ url_for('generate_preview') }}",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify(data),
            success: function(resp) {
              previewCont.empty();
              if (resp.error) {
                  previewCont.html(`<p class="text-danger text-center">Error: ${resp.error}</p>`);
                  return;
              }
              if (!resp.previews?.length) {
                previewCont.html("<p class='text-center'>No previews generated for the selection.</p>");
                return;
              }
              resp.previews.forEach((url) => {
                $("<div>")
                  .addClass("preview-page")
                  .append($("<img>").attr("src", url + "?t=" + Date.now()))
                  .appendTo(previewCont);
              });
            },
            error: function(xhr, status, error) {
              console.error("Preview error. Status:", status, "Error:", error, "Response:", xhr.responseText);
              previewCont.html("<p class='text-danger text-center'>Error generating preview.</p>");
            },
            complete: function() {
                preloader.removeClass("active");
            }
          });
        }

        // ========== SETTINGS CHANGE TRIGGERS ==========
        $("#numCopies, #pageSize, #colorOption, #orientationOption").on(
          "change",
          schedulePreview
        );

        // ========== CONTINUE BUTTON ==========
        $("#continueBtn").click(function () {
          const selectedPages = $("#pageSelection").val();
          if (!selectedPages) {
              alert("Please select at least one page to print.");
              return;
          }
          const opts = {
              pageSelection: selectedPages,
              numCopies: $("#numCopies").val(),
              pageSize: $("#pageSize").val(),
              colorOption: $("#colorOption").val(),
              orientationOption: $("#orientationOption").val() || "auto",
              fileName: currentUploadedFileName,
              originalDownloadName: originalSelectedDownloadName
          };
          sessionStorage.setItem("printOptions", JSON.stringify(opts));

          console.log("Continue button clicked. Attempting to clear server's downloads folder...");
          preloader.addClass("active"); // Show preloader while this happens

          $.ajax({
              url: "{{ url_for('clear_downloads_folder_route') }}", // Matches the function name in app.py
              method: "POST",
              contentType: "application/json",
              // No 'data' is sent, as the backend route knows what to do
              success: function(response) {
                  console.log("Server response from clearing downloads folder:", response.message);
                  if (response.success) {
                      console.log("Downloads folder cleared successfully by server.");
                  } else {
                      console.error("Server reported issues clearing downloads folder:", response.message);
                      if (response.errors) {
                          console.error("Specific errors:", response.errors);
                      }
                      // Optionally alert the user if immediate feedback is critical before redirect
                      // alert("Notice: Could not fully clear downloads folder on server. " + response.message);
                  }
              },
              error: function(xhr, status, error) {
                  console.error("Failed to request clearing of downloads folder. Status:", status, "Error:", error);
                  let serverErrorMsg = "Could not reach server to clear downloads folder.";
                  if(xhr.responseJSON && xhr.responseJSON.message) {
                      serverErrorMsg = xhr.responseJSON.message;
                  } else if (xhr.responseText) {
                      serverErrorMsg = xhr.responseText;
                  }
                  console.error("Server raw error response:", xhr.responseText);
                  // Optionally alert critical failure
                  // alert("Critical error: Failed to send request to clear downloads folder: " + serverErrorMsg);
              },
              complete: function() {
                  // This block executes after success or error.
                  // Now, clear the display on the frontend and then redirect.
                  console.log("Clearing frontend display of downloads and redirecting.");
                  $("#recentDownloadsContainer").empty().html("<p class='text-center w-100'>Recent downloads list cleared. Navigate from Step 2 to refresh if needed.</p>");
                  $("#selectedDownloadInfo").hide();
                  selectedDownloadNameSpan.text("N/A"); 
                  originalSelectedDownloadName = ""; 

                  preloader.removeClass("active"); // Hide preloader
                  window.location.href = "{{ url_for('result') }}";
              }
          });
      });

        // ========== CLOSE PRINT OPTIONS MODAL - CLEAR STATE ==========
        function resetPrintOptionsAndSelection() {
            recentDownloadsContainer.find(".list-group-item").removeClass("active");
            selectedDownloadInfo.hide();
            selectedDownloadNameSpan.text("N/A");

            $("#pageSelectionContainer").empty();
            $("#previewContainer").html('<p class="text-center">Select options to generate preview.</p>');
            $("#pageSelection").val("");
            $("#numCopies").val(1);
            $("#orientationOption").val("auto");
            $("#colorOption").val("Color");
            
            totalPagesInDocument = 0;
            currentUploadedFileName = "";
            originalSelectedDownloadName = "";
            $("#printFileName").text("N/A");
            $("#totalPages").text("N/A");
        }

        $("#closeModalBtn").click(resetPrintOptionsAndSelection);
        $("#closePrintOptionsModalCross").click(resetPrintOptionsAndSelection);


        // ========== ZOOM HANDLERS (for QR code) ==========
        window.openZoom = function() { $("#zoomOverlay").css("display", "flex"); }
        window.closeZoom = function() { $("#zoomOverlay").hide(); }
        $("#zoomOverlay").click(function(event) {
            if (event.target === this) { // Only close if overlay background is clicked
                closeZoom();
            }
        });
        $(".close-zoom").click(function(event){
            event.stopPropagation(); // Prevent overlay click from triggering
            closeZoom();
        });


        // ========== TOFFEESHARE MODAL HANDLER ==========
        const toffeeShareLink = document.getElementById("openToffeeShareModal");
        const toffeeShareModal = $('#toffeeshareModal');
        const toffeeShareIframe = document.getElementById("toffeeshareIframe");

        if (toffeeShareLink && toffeeShareModal.length && toffeeShareIframe) {
            toffeeShareLink.addEventListener("click", function(event) {
                event.preventDefault();
                const url = this.href;
                if (url) {
                    toffeeShareIframe.src = url;
                    toffeeShareModal.modal('show');
                }
            });

             toffeeShareModal.on('hidden.bs.modal', function () {
                toffeeShareIframe.src = ""; 
             });
        } else {
             console.error("Required elements for ToffeeShare modal not found.");
        }

      }); // End of $(document).ready
    </script>
  </body>
</html>