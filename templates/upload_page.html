<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Wireless File Transfer</title>
    <link
      href="{{ url_for('static', filename='images/logo.jpg') }}"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link href="./../static/css/upload_page.css" rel="stylesheet" />
    <link href="./../static/css/header.css" rel="stylesheet" />
    <style>
      body {
        overflow: hidden;
      }

      .zoom-overlay {
        display: none;
        position: fixed;
        z-index: 9999;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: rgba(0, 0, 0, 0.8);
        justify-content: center;
        align-items: center;
      }
      .zoom-overlay img {
        max-width: 90%;
        max-height: 90%;
      }
      .close-zoom {
        position: absolute;
        top: 20px;
        right: 30px;
        font-size: 30px;
        color: white;
        cursor: pointer;
        font-weight: bold;
      }
      .centered-text {
        text-align: center;
      }
      .btn-center {
        display: flex;
        justify-content: center;
        margin-top: 15px;
      }

      .sticky-button {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #700000;
        color: white;
        border: none;
        border-radius: 50px;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        z-index: 1000;
      }

      .modal-body-video {
        text-align: center;
      }

      .modal-body-video iframe {
        width: 100%;
        height: 400px;
      }

      .step {
        display: none;
      }
      .step.active {
        display: block;
        animation: fadeIn 0.5s ease-in-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .stepper {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 20px;
        gap: 60px;
      }
      .stepper .step-indicator {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #ddd;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #333;
        font-size: 18px;
        position: relative;
        transition: background 0.3s, color 0.3s;
      }
      .stepper .step-indicator.active {
        background: #700000;
        color: white;
      }
      .stepper .step-indicator:not(:last-child)::after {
        content: "";
        position: absolute;
        width: 60px;
        height: 4px;
        background: #ddd;
        top: 50%;
        left: 100%;
        margin-left: 10px;
      }
      .stepper .step-indicator.active:not(:last-child)::after {
        background: #700000;
      }

      .preview-container {
        max-height: 400px;
        overflow-y: scroll;
        border: 1px solid #ccc;
        padding: 10px;
        width: 300px;
      }
      .preview-page {
        margin-bottom: 10px;
        border: 1px solid #ddd;
        background-color: #212529;
      }
      .preview-page img {
        max-width: 100%; /* Ensures image does not stretch horizontally */
        height: auto; /* Ensures the height adjusts automatically */
        display: block;
        margin: auto;
      }
      .modal-body {
        display: flex;
        flex-direction: column;
      }
      .form-section {
        flex: 1;
      }
      .preview-section {
        flex: 1;
        margin-left: 20px;
      }
      /* Preloader Styling */
      #preloader {
        display: none;
        position: fixed;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        z-index: 9999;
        top: 0;
        left: 0;
        justify-content: center;
        align-items: center;
      }

      .spinner {
        border: 6px solid #f3f3f3;
        border-top: 6px solid #700000;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .btn {
        display: flex;
        gap: 10px;
        margin-top: 10px;
        padding: 10px;
      }

      .qr-code-css {
        width: 120px;
        height: 120px;
        margin: 0 auto;
        background-image: url("./../static/images/toffeshare.png");
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        cursor: pointer;
      }

      #pageSelection:disabled {
        background-color: #f0f0f0;
        color: #888;
      }

      /* Custom style for the theme red button */
      .btn-theme-red {
        color: #fff;
        background-color: #700000;
        border-color: #700000;
      }

      .btn-theme-red:hover {
        color: #fff;
        background-color: #5a0000;
        border-color: #5a0000;
      }

      .btn-theme-red:focus,
      .btn-theme-red.focus {
        box-shadow: 0 0 0 0.2rem rgba(112, 0, 0, 0.5);
      }

      .btn-theme-red.disabled,
      .btn-theme-red:disabled {
        color: #fff;
        background-color: #700000;
        border-color: #700000;
        opacity: 0.65;
      }

      #pageSelectionContainer button {
        width: 48px;
        height: 48px;
        margin: 4px;
        padding: 0;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 16px;
        align-items: center;
        justify-content: center;
      }
      #pageSelectionContainer button.selected {
        background-color: #700000;
        color: #fff;
        border-color: #600;
        align-items: center;
        justify-content: center;
      }

        /* Styles for the new ToffeeShare modal iframe */
      #toffeeshareModal iframe {
          width: 100%;
          height: 80vh; /* Adjust height as needed */
          border: none; /* Remove default iframe border */
      }
    </style>
  </head>
  <body>
    <div id="preloader">
      <div class="spinner"></div>
    </div>
    <div
      class="modal fade"
      id="termsModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="termsModalLabel"
      aria-hidden="true"
      data-backdrop="static"
      data-keyboard="false"
    >
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header" style="background-color: #700000">
            <h5 class="modal-title" id="termsModalLabel">
              Terms and Agreements
            </h5>
          </div>
          <div class="modal-body">
            <p>
              We value your privacy and are committed to protecting your data.
              By proceeding, you agree to the following:
            </p>
            <div style="margin-left: 20px">
              <h5>Data Use:</h5>
              <ul style="list-style-type: none">
                <li>
                  ✅ Your files will only be accessed for the purpose of
                  providing the requested service or functionality.
                </li>
                <li>
                  ✅ We do not store or share your files with third parties
                  unless explicitly authorized by you.
                </li>
              </ul>
              <h5>Permissions:</h5>
              <ul style="list-style-type: none">
                <li>
                  ✅ This application requires access to your files to enable
                  the uploading of documents. This feature allows you to
                  securely select files from your device and send them to the
                  printer for printing.
                </li>
              </ul>
              <h5>Security Measures:</h5>
              <ul style="list-style-type: none">
                <li>
                  ✅ All accessed data will be handled securely, adhering to
                  industry-standard encryption and privacy practices.
                </li>
              </ul>
            </div>
            <p>
              Do you agree to allow this application to access your files for
              the specified purpose?
            </p>
            <div class="form-group">
              <label for="acceptTerms">
                <input id="acceptTerms" type="checkbox" /> I agree to the terms
                and conditions.
              </label>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="window.history.back();"
            >
              Decline
            </button>
            <button
              type="button"
              class="btn btn-secondary"
              id="acceptTermsButton"
              disabled
            >
              Accept
            </button>
          </div>
        </div>
      </div>
    </div>
    <header class="header">
      <img alt="sample" src="./../static/images/pup-logo.png" />
      <div class="center-text">
        INSTAPRINT
        <h6>WIRELESS FILE TRANSFER</h6>
      </div>
      <img alt="sample" src="./../static/images/cpe-logo.png" />
    </header>
    <div class="container">
      <div class="stepper">
        <div class="step-indicator active" id="step1-indicator">1</div>
        <div class="step-indicator" id="step2-indicator">2</div>
        <div class="step-indicator" id="step3-indicator">3</div>
      </div>
      <div class="step active" id="step1">
        <div class="centered-text">
          <h2>Step 1: Go to ToffeeShare</h2>
          <p>Use the QR code or type the link below:</p>
          <div class="qr-code-css" onclick="openZoom()"></div>
          <br />
          <b>https://toffeeshare.com/</b>
        </div>
        <div class="zoom-overlay" id="zoomOverlay" onclick="closeZoom()">
          <span class="close-zoom" onclick="closeZoom()">×</span>
          <img alt="Zoomed QR Code" src="./../static/images/toffeshare.png" />
        </div>
        <div class="btn btn-center">
          <button class="btn btn-secondary" onclick="window.location.href='/'">
            Cancel
          </button>
          <button class="btn btn-primary next-btn">Next</button>
        </div>
      </div>
      <div class="step" id="step2">
        <div class="centered-text">
          <h2>Step 2: Upload your file using Toffeeshare</h2>
          <p>
            Use the <b>link below</b> to directly transfer files from your
            device to this kiosk. Simply click <b>'share to nearby PC'</b> on
            your device and <b>scan the QR code</b> to share your file.
          </p>
          <div class="btn-center">
            <a
              class="btn btn-primary"
              href="{{ toffee_share_link }}"
              id="openToffeeShareModal"
              target="_blank"
              >Go To Toffeshare</a
            >
          </div>
        </div>
        <div class="btn btn-center">
          <button class="btn btn-success prev-btn">Previous</button>
          <button class="btn btn-primary next-btn">Next</button>
          <button class="btn btn-secondary" onclick="window.location.href='/'">
            Cancel
          </button>
        </div>
      </div>
      <div class="step" id="step3">
        <div class="centered-text">
          <h2>Step 3: Upload Your File</h2>
          <form id="uploadForm">
            <div class="form-group custom-file-upload">
              <input
                class="file-input"
                id="file"
                name="file"
                required=""
                type="file"
              />
              <label class="file-label" for="file">
                <span class="file-label-text">Choose a file</span>
                <span
                  class="file-button"
                  style="background-color: #700000; border: #700000"
                  >Browse</span
                >
              </label>
            </div>
            <div class="file-info" id="fileInfo" style="display: none">
              <p><strong>File Name:</strong> <span id="fileName">N/A</span></p>
              <p><strong>File Size:</strong> <span id="fileSize">N/A</span></p>
              <div class="btn-center">
                <button class="btn btn-danger" id="removeFileBtn" type="button">
                  Remove File
                </button>
              </div>
            </div>
            <div class="btn btn-center">
              <button
                class="btn btn-success prev-btn"
                disabled=""
                id="prevStepBtn"
              >
                Previous
              </button>
              <button
                class="btn btn-success"
                style="background-color: #700000; border: #700000"
                type="submit"
              >
                Upload
              </button>
              <button
                class="btn btn-secondary"
                onclick="window.location.href='/'"
              >
                Cancel
              </button>
            </div>
          </form>
        </div>
      </div>
      <button
        class="sticky-button"
        data-target="#videoDemoModal"
        data-toggle="modal"
      >
        Video Demo
      </button>
      <div class="modal fade" id="videoDemoModal" role="dialog" tabindex="-1">
        <div class="modal-dialog modal-lg" role="document">
          <div class="modal-content">
            <div class="modal-header" style="background-color: #700000">
              <h5 class="modal-title">Website Usage Demo</h5>
              <button
                aria-label="Close"
                class="close"
                data-dismiss="modal"
                type="button"
              >
                <span aria-hidden="true">×</span>
              </button>
            </div>
            <div class="modal-body modal-body-video">
              <iframe
                allowfullscreen=""
                frameborder="0"
                src="https://www.youtube.com/embed/61Ch4zkjcpI"
              ></iframe>
            </div>
            <div class="modal-footer">
              <button
                class="btn btn-secondary"
                data-dismiss="modal"
                type="button"
              >
                Close
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal" id="printOptionsModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header" style="background-color: #700000">
            <h5 class="modal-title">Print Options</h5>
          </div>
          <div class="preview-modal-body" style="display: flex; padding: 20px">
            <div class="form-section">
              <div class="form-group">
                <label>Pages to Print</label>
                <div
                  id="pageSelectionContainer"
                  class="d-flex flex-wrap mb-2"
                ></div>
                <input type="hidden" id="pageSelection" />
                <small class="form-text text-muted">
                  Tap each page you want to print.
                </small>
              </div>

              <div class="form-group">
                <label for="numCopies">Number of Copies</label>
                <input
                  class="form-control"
                  id="numCopies"
                  min="1"
                  type="number"
                  value="1"
                />
              </div>
              <div class="form-group">
                <label for="orientationOption">Orientation</label>
                <select class="form-control" id="orientationOption">
                  <option value="auto">Auto</option>
                  <option value="portrait">Portrait</option>
                  <option value="landscape">Landscape</option>
                </select>
              </div>

              <div class="form-group">
                <label for="pageSize">Page Size</label>
                <select class="form-control" id="pageSize">
                  <option value="A4">A4</option>
                  <option value="Short">Short</option>
                  <option value="Long">Long</option>
                </select>
              </div>
              <div class="form-group">
                <label for="colorOption">Color Option</label>
                <select class="form-control" id="colorOption">
                  <option value="Color">Color</option>
                  <option value="Grayscale">Grayscale</option>
                </select>
              </div>
            </div>
            <div class="preview-section">
              <h6>File: <span id="printFileName"></span></h6>
              <h6>Total Pages: <span id="totalPages"></span></h6>
              <h6>Preview</h6>
              <div class="preview-container" id="previewContainer"></div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              class="btn btn-secondary"
              data-dismiss="modal"
              id="closeModalBtn"
            >
              Exit
            </button>
            <button class="btn btn-primary" id="continueBtn">Continue</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="toffeeshareModal" tabindex="-1" role="dialog" aria-labelledby="toffeeshareModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header" style="background-color: #700000; color: white;">
            <h5 class="modal-title" id="toffeeshareModalLabel">ToffeeShare</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color: white;">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <iframe id="toffeeshareIframe" src="" frameborder="0" style="width: 100%; height: 80vh;"></iframe>
          </div>
           <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script>
      $(document).ready(function () {
        let previewTimeout;
        let totalPages = 0;
        let fileName = "";

        // ========== STEP NAVIGATION & TERMS ==========
        let currentStep = 1;
        function showStep(step) {
          currentStep = step; // FIX: update currentStep here!
          $(".step").removeClass("active");
          $("#step" + step).addClass("active");
          $(".step-indicator").removeClass("active");
          $("#step" + step + "-indicator").addClass("active");
          // Keep prevStepBtn disabled in step 3 unless file is removed
           $("#prevStepBtn").prop(
             "disabled",
             step === 3 && $("#file").val() !== ""
           );
        }
        $(".next-btn").click(() => {
          if (currentStep < 3) showStep(++currentStep);
        });
        $(".prev-btn").click(() => {
          if (currentStep > 1) showStep(--currentStep);
        });
        // Only show terms modal if user hasn't accepted (you might need a cookie/local storage check)
        // For now, it shows every time the page loads.
        $("#termsModal")
          .modal({ backdrop: "static", keyboard: false })
          .modal("show");
        $("#acceptTerms").change(function () {
          $("#acceptTermsButton")
            .prop("disabled", !this.checked)
            .toggleClass("btn-secondary btn-theme-red"); // Toggle classes for styling
        });
        $("#acceptTermsButton").click(function () {
          if (!this.disabled) { // Check if button is not disabled
             $("#termsModal").modal("hide");
          }
        });


        // ========== FILE UPLOAD HANDLING ==========
        $("#file").change(function () {
          const f = this.files[0];
          if (f) {
            $("#fileInfo").show();
            $("#fileName").text(f.name);
            $("#fileSize").text((f.size / 1024).toFixed(2) + " KB");
            // No showStep(3) here, as the next button already takes them to step 3
            $("#prevStepBtn").prop("disabled", true); // Disable 'Previous' button in step 3 once file is selected
          }
        });
        $("#removeFileBtn").click(() => {
          $("#file").val("");
          $("#fileInfo").hide();
          $("#fileName, #fileSize").text("N/A");
           $("#prevStepBtn").prop("disabled", false); // Enable 'Previous' button if file is removed
        });

        // ========== PAGE PICKER & PREVIEW ==========
        function buildPagePicker(n) {
          totalPages = n;
          const c = $("#pageSelectionContainer").empty();
          for (let i = 1; i <= n; i++) {
            $("<button>")
              .attr("type", "button")
              .text(i)
              .addClass("btn btn-outline-secondary")
              .on("click", function () {
                $(this).toggleClass("selected");
                updatePageSelection();
              })
              .appendTo(c);
          }
          // Select all pages by default
          c.find("button").addClass("selected");
          updatePageSelection();
        }
        function updatePageSelection() {
          const sel = $("#pageSelectionContainer button.selected")
            .map((_, b) => $(b).text())
            .get()
            .sort((a, b) => a - b);
          $("#pageSelection").val(sel.join(","));
          // Only schedule preview if there are selected pages
          if (sel.length > 0) {
            schedulePreview();
          } else {
             $("#previewContainer").html("<p>No pages selected for preview.</p>");
             clearTimeout(previewTimeout); // Clear any pending preview updates
          }
        }
        function schedulePreview() {
          clearTimeout(previewTimeout);
          previewTimeout = setTimeout(updatePreview, 300);
        }
        function updatePreview() {
          if (!$("#pageSelection").val() || totalPages === 0) return; // Check if pages are selected
          const data = {
            pageSelection: $("#pageSelection").val(),
            numCopies: $("#numCopies").val(),
            pageSize: $("#pageSize").val(),
            colorOption: $("#colorOption").val(),
            orientationOption: $("#orientationOption").val() || "auto", // Ensure a default value
          };
          const pc = $("#previewContainer").html("<p>Loading preview…</p>"); // Show loading message
          $.ajax({
            url: "/generate_preview", // Ensure this endpoint exists and works
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify(data),
            success(resp) {
              pc.empty(); // Clear loading message
              if (!resp.previews?.length) {
                return pc.html("<p>No previews found.</p>");
              }
              resp.previews.forEach((url) => {
                $("<div>")
                  .addClass("preview-page")
                  .append(
                    $("<img>")
                      .attr("src", url + "?t=" + Date.now()) // Add timestamp to bust cache
                      .css({
                        "max-width": "100%", // Use 100% to fit preview container
                        "height": "auto", // Auto height
                        "display": "block",
                        "margin": "auto",
                      })
                  )
                  .appendTo(pc);
              });
            },
            error(xhr, status, error) {
              console.error("Preview error:", error); // Log error for debugging
              pc.html("<p>Error generating preview.</p>");
            },
          });
        }

        // ========== UPLOAD FORM SUBMISSION ==========
        $("#uploadForm").submit(function (e) {
          e.preventDefault();
          // Check if a file is selected
          if (!$("#file").val()) {
              alert("Please select a file first.");
              return; // Stop submission if no file is selected
          }

          $("#preloader").show(); // Show preloader before AJAX
          $.ajax({
            url: "/upload", // Ensure this endpoint exists and works
            method: "POST",
            data: new FormData(this),
            contentType: false,
            processData: false,
            success(response) {
              fileName = response.fileName;
              totalPages = response.totalPages; // Store total pages
              buildPagePicker(totalPages); // Build picker based on total pages
              $("#printFileName").text(fileName);
              $("#totalPages").text(totalPages); // Display total pages
              $("#printOptionsModal").modal("show"); // Show print options modal
              // Initial preview load is handled by buildPagePicker -> updatePageSelection -> schedulePreview
            },
            error(xhr, status, error) {
              console.error("Upload error:", error); // Log error for debugging
              alert(xhr.responseJSON?.error || "Upload failed. Please try again.");
            },
            complete() {
              $("#preloader").hide(); // Hide preloader after AJAX completes
            },
          });
        });

        // ========== SETTINGS CHANGE TRIGGERS ==========
        $("#numCopies, #pageSize, #colorOption, #orientationOption").on(
          "change",
          schedulePreview // Schedule preview update on settings change
        );

        // ========== CONTINUE BUTTON ==========
        $("#continueBtn").click(function () {
          const selectedPages = $("#pageSelection").val();
           if (!selectedPages) {
                alert("Please select at least one page to print.");
                return; // Prevent continue if no pages selected
           }
          const opts = {
            pageSelection: selectedPages,
            numCopies: $("#numCopies").val(),
            pageSize: $("#pageSize").val(),
            colorOption: $("#colorOption").val(),
            orientationOption: $("#orientationOption").val() || "auto", // Ensure a default value
            fileName, // Use stored fileName
          };
          sessionStorage.setItem("printOptions", JSON.stringify(opts));
          window.location.href = "/result"; // Navigate to the result page
        });

        // ========== CLOSE PRINT OPTIONS MODAL - CLEAR FILE ==========
        $("#closeModalBtn").click(function() {
            // Clear the file input and info when modal is closed
            $("#file").val("");
            $("#fileInfo").hide();
            $("#fileName, #fileSize").text("N/A");
             $("#prevStepBtn").prop("disabled", false); // Re-enable 'Previous' button
            // Optionally clear preview and page picker
            $("#pageSelectionContainer").empty();
            $("#previewContainer").empty();
            $("#pageSelection").val("");
            totalPages = 0;
            fileName = "";
        });


        // ========== ZOOM HANDLERS (for QR code) ==========
        $(".qr-code-css").click(() => $("#zoomOverlay").show());
        $(".close-zoom, #zoomOverlay").click(() => $("#zoomOverlay").hide());


        // ========== NEW TOFFEESHARE MODAL HANDLER ==========
        const toffeeShareLink = document.getElementById("openToffeeShareModal");
        const toffeeShareModal = $('#toffeeshareModal'); // Use jQuery for Bootstrap modal functions
        const toffeeShareIframe = document.getElementById("toffeeshareIframe");

        if (toffeeShareLink && toffeeShareModal.length && toffeeShareIframe) {
            toffeeShareLink.addEventListener("click", function(event) {
                event.preventDefault(); // Prevent the default link behavior
                const url = this.href; // Get the URL from the link's href
                if (url) {
                    toffeeShareIframe.src = url; // Set the iframe's source
                    toffeeShareModal.modal('show'); // Show the Bootstrap modal
                }
            });

             // Clear the iframe source when the modal is hidden
             toffeeShareModal.on('hidden.bs.modal', function () {
                toffeeShareIframe.src = ""; // Stop any loading content
             });
        } else {
             console.error("Required elements for ToffeeShare modal not found.");
        }

      }); // End of $(document).ready
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const fileInput = document.getElementById("file");
        const fileInfo = document.getElementById("fileInfo");
        const fileNameSpan = document.getElementById("fileName"); // Renamed to avoid conflict
        const fileSizeSpan = document.getElementById("fileSize"); // Renamed to avoid conflict
        const removeFileBtn = document.getElementById("removeFileBtn");
        const prevStepBtn = document.getElementById("prevStepBtn");

        // This part seems to be duplicated/handled by the jQuery .change() above,
        // but keeping it separate might be intentional. Ensure logic is consistent.
        if (fileInput) { // Check if element exists
            fileInput.addEventListener("change", function () {
              if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                fileNameSpan.textContent = file.name; // Use renamed variable
                fileSizeSpan.textContent = (file.size / 1024).toFixed(2) + " KB"; // Use renamed variable
                fileInfo.style.display = "block";
                // prevStepBtn.disabled = true; // This logic is better handled by the step function or upload success
              }
            });
        }


        if (removeFileBtn && fileInput && fileInfo && fileNameSpan && fileSizeSpan && prevStepBtn) { // Check if all elements exist
            removeFileBtn.addEventListener("click", function () {
              fileInput.value = ""; // Clear file input
              fileNameSpan.textContent = "N/A"; // Use renamed variable
              fileSizeSpan.textContent = "N/A"; // Use renamed variable
              fileInfo.style.display = "none"; // Hide file info section
              // prevStepBtn.disabled = false; // This logic is handled in the jQuery ready function's removeFileBtn click
            });
        }
      });
    </script>
  </body>
</html>