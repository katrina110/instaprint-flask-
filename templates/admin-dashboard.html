<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instaprint Dashboard</title>
    <link href="/static/css/admin-dashboard.css" rel="stylesheet" /> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        /* CSS for cards copied from admin-sales.html */
        .stats {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px; /* Added some margin below stats cards */
        }
        .stats .card {
            background-color: #ffffff;
            padding: 25px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            min-width: 220px;
            flex: 1;
            max-width: 280px;
            border: 1px solid #e0e0e0;
            margin-top: 10px;
        }
        .stats .card .card-content {
            font-size: 2.25rem; /* */
            font-weight: 700; /* */
            color: green; /* As per admin-sales.html CSS */
            margin-bottom: 12px; /* */
            line-height: 1.2; /* */
        }
        .stats .card .card-content .currency {
            font-size: 1.75rem; /* */
            margin-right: 4px; /* */
            color: #333; /* */
        }
        /* This rule specifically targets the .amount span within the cards */
        .stats .card .card-content span.amount { /* Made selector more specific */
            font-size: 2rem; /* From .amount rule in admin-sales.html */
             /* If color: green from card-content is desired for the number, it will inherit.
                If a different color specific to amount is needed, specify here. */
        }
        .stats .card .card-label {
            font-size: 1rem; /* */
            color: #495057; /* */
            font-weight: 500; /* */
        }

        /* Basic layout styles if not already in admin-dashboard.css */
        .container {
            display: flex;
        }
        .menu {
            flex-shrink: 0;
            /* Assuming width is set in admin-dashboard.css */
        }
        .contents {
            flex-grow: 1;
            padding: 20px;
        }
    </style>
</head>

<body>
    <div class="container">
        <leftmenu class="menu">

            <div class="account">
                <i class="fa-solid fa-user-circle profile-icon"></i>
                <div class="account-info">
                    <p class="name">InstaPrint</p>
                    <p class="role">Admin</p>
                </div>
            </div>

            <h2>Navigation</h2>

            <ul>
                <li><i class="fa-solid fa-house"></i> <a href="{{ url_for('admin_dashboard') }}">Dashboard</a></li>
                <li><i class="fa-solid fa-print"></i> <a href="{{ url_for('admin_printed_pages') }}">Files Upload</a></li>
                <li><i class="fa-solid fa-comments"></i> <a href="{{ url_for('admin_feedbacks') }}">Feedbacks</a></li>
                <li><i class="fa-solid fa-upload"></i> <a href="{{ url_for('admin_activity_log') }}">Activity Log</a></li>
                <li><i class="fa-solid fa-chart-bar"></i> <a href="{{ url_for('admin_sales') }}">Total Sales</a></li>
            </ul>
            
        </leftmenu>

        <content class="contents">

            <div class="stats">
                <div class="card">
                    <div class="card-content">
                        <span class="currency">₱</span><span class="amount">{{ "%.0f"|format(data.total_sales|float) }}</span>
                    </div>
                    <div class="card-label">Total Sales</div>
                </div>
                <div class="card">
                    <div class="card-content">
                        <span class="amount">{{ data.printed_pages }}</span>
                    </div>
                    <div class="card-label">Printed Pages</div>
                </div>
                <div class="card">
                    <div class="card-content">
                        <span class="amount">{{ data.files_uploaded }}</span>
                    </div>
                    <div class="card-label">Files Uploaded</div>
                </div>
                <div class="card">
                    <div class="card-content">
                        <span class="currency">₱</span><span class="amount">{{ "%.0f"|format(data.current_balance|float) }}</span>
                    </div>
                    <div class="card-label">Coin Hopper Balance</div>
                </div>
            </div>

            <div class="charts">
                <div class="chart-box position-relative" style="cursor:pointer;" data-bs-toggle="modal" data-bs-target="#transactionModal">
                    <div class="card-label">Transaction History</div>
                    <button type="button" class="btn btn-light rounded-circle position-absolute top-0 end-0 m-2"
                            data-bs-toggle="modal" data-bs-target="#transactionModal" title="View All">
                        <i class="fas fa-arrow-up-right-from-square"></i>
                    </button>
                    <canvas id="transactionMethodChart"></canvas>
                </div>

                <div class="sales-box">
                    <div class="card-label">Sales in Year</div>
                    <canvas id="salesChart"></canvas>
                </div>
            </div>

            <div class="modal fade" id="transactionModal" tabindex="-1" aria-labelledby="transactionModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="transactionModalLabel">Transaction History</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <ul class="list-group" id="transaction-list"> {% for transaction in data.sales_history %}
                                <li class="list-group-item">
                                    <strong>{{ transaction.method }}</strong> - ₱{{ "%.2f"|format(transaction.amount|float) }}<br>
                                    <small class="text-muted">{{ transaction.date }} {{ transaction.time }}</small>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </content>
    </div> 

    <script>
        var salesData = {{ data.sales_chart | tojson }}; //
        const socket = io();
        
        const transactionMethodData = {{ data.transaction_method_summary | tojson }}; //
        
        const ctx = document.getElementById('transactionMethodChart').getContext('2d');
        
        const transactionMethodChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['GCash', 'Coinslot'],
                datasets: [{
                    label: 'Transaction Method',
                    data: [transactionMethodData.gcash, transactionMethodData.coinslot],
                    backgroundColor: [
                        'rgba(54, 162, 235, 0.7)',   // GCash: Blue
                        'rgba(255, 205, 86, 0.7)'    // Coinslot: Yellow
                    ],
                    borderColor: [
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 205, 86, 1)'
                    ],
                    borderWidth: 1,
                }]
            },
            options: {
                responsive: true,
                layout: {
                    padding: {
                        top: 10,
                        bottom: 10
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            boxWidth: 20,
                            padding: 15,
                            font: {
                                size: 14,
                                family: 'Arial'
                            },
                            color: '#333',
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed || 0; // Handle cases where parsed value might be undefined
                                return `${context.label}: ₱${value.toFixed(2)}`;
                            }
                        }
                    },
                }
            }
        });

        socket.on('new_transaction', function(data) {
            // Update total sales card (Card 1)
            const totalSalesAmountSpan = document.querySelector('.stats .card:nth-child(1) .amount'); //
            if (totalSalesAmountSpan) {
                let currentTotalOnCard = parseFloat(totalSalesAmountSpan.textContent) || 0; //
                currentTotalOnCard += parseFloat(data.amount);
                totalSalesAmountSpan.textContent = currentTotalOnCard.toFixed(2); //
            }

            // Update chart data
            if (data.method === "GCash") {
                transactionMethodChart.data.datasets[0].data[0] += parseFloat(data.amount);
            } else if (data.method === "Coinslot") {
                transactionMethodChart.data.datasets[0].data[1] += parseFloat(data.amount);
            }
            transactionMethodChart.update();

            // Add new transaction to the modal list
            const transactionList = document.getElementById('transaction-list'); //
            if (transactionList) {
                const newItem = document.createElement('li');
                newItem.classList.add('list-group-item'); 
                
                const formattedAmount = parseFloat(data.amount).toFixed(2);
                newItem.innerHTML = `<strong>${data.method}</strong> - ₱${formattedAmount}<br><small class="text-muted">${data.timestamp}</small>`; //
                transactionList.prepend(newItem); 

                const maxItemsToShow = 10; 
                while (transactionList.children.length > maxItemsToShow) { //
                    transactionList.removeChild(transactionList.lastChild);
                }
            }
        });
    </script>
    <script src="./../static/js/main.js"></script> </body>
</html>