<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="icon" type="image/jpeg" href="{{ url_for('static', filename='images/logo.jpg') }}">
    <link href="/static/css/admin-dashboard.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        /* CSS for cards */
        .stats {
            display: flex;
            justify-content: space-between; 
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px; /* This will be the gap to the charts row */
        }
        .stats .card {
            background-color: #ffffff;
            padding: 25px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            min-width: 220px; 
            flex: 1; 
            max-width: 280px; 
            border: 1px solid #e0e0e0;
            margin-top: 0; 
        }
        .stats .card .card-content {
            font-size: 2.25rem; 
            font-weight: 700; 
            color: green; 
            margin-bottom: 12px; 
            line-height: 1.2; 
        }
        .stats .card .card-content .currency {
            font-size: 1.75rem; 
            margin-right: 4px; 
            color: #333; 
        }
        .stats .card .card-content span.amount { 
            font-size: 2rem; 
        }
        .stats .card .card-label {
            font-size: 1rem; 
            color: #000000; 
            font-weight: bold; 
        }

        /* Basic layout styles */
        .container {
            display: flex;
        }
        .menu { 
            flex-shrink: 0; 
        }
        .contents { 
            flex-grow: 1; 
            padding: 20px;
        }

        /* Styles for the charts row and individual chart boxes */
        .charts {
            display: flex;
            gap: 20px; 
            margin-top: 0; 
            align-items: flex-start; 
        }

        .chart-box, 
        .sales-box {
            background-color: #ffffff;
            padding: 20px; 
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
            border: 1px solid #e0e0e0; 
            display: flex; 
            flex-direction: column; 
        }

        .chart-box .card-label, 
        .sales-box .card-label {
            font-size: 1rem; 
            color: #000000; 
            font-weight: bold; 
            margin-bottom: 15px; 
            text-align: center; 
        }
        
        .chart-box canvas, 
        .sales-box canvas {
            min-height: 250px; 
        }

        .chart-box { 
            flex-grow: 1;  
            flex-shrink: 1;
            flex-basis: 0; 
        }

        .sales-box { 
            flex-grow: 3;  
            flex-shrink: 1;
            flex-basis: 0; 
            max-height: 450px; 
            /* overflow-y: auto; /* Removed to let chart fully manage its space within max-height */
        }
    </style>
</head>

<body>
    <div class="container">
        <leftmenu class="menu">
            <div class="account">
                <img src="{{ url_for('static', filename='images/logo.jpg') }}" alt="InstaPrint Logo" class="profile-icon" style="max-width: 75px;">
                <div class="account-info">
                    <p class="name">InstaPrint</p>
                    <p class="role">Admin</p>
                </div>
            </div>
            <ul>
                <li><i class="fa-solid fa-house"></i> <a href="{{ url_for('admin_dashboard') }}">Dashboard</a></li>
                <li><i class="fa-solid fa-print"></i> <a href="{{ url_for('admin_printed_pages') }}">Uploaded Files</a></li>
                <li><i class="fa-solid fa-comments"></i> <a href="{{ url_for('admin_feedbacks') }}">Feedbacks</a></li>
                <li><i class="fa-solid fa-upload"></i> <a href="{{ url_for('admin_activity_log') }}">Error Logs</a></li>
                <li><i class="fa-solid fa-chart-bar"></i> <a href="{{ url_for('admin_sales') }}">Total Sales</a></li>
            </ul>
        </leftmenu>

        <content class="contents">
            <div class="stats">
                <div class="card">
                    <div class="card-content">
                        <span class="currency">₱</span><span class="amount">{{ "%.0f"|format(data.total_sales|float) }}</span>
                    </div>
                    <div class="card-label">Total Sales</div>
                </div>
                <div class="card">
                    <div class="card-content">
                        <span class="amount">{{ data.printed_pages }}</span>
                    </div>
                    <div class="card-label">Printed Pages</div>
                </div>
                <div class="card">
                    <div class="card-content">
                        <span class="amount">{{ data.files_uploaded }}</span>
                    </div>
                    <div class="card-label">Files Uploaded</div>
                </div>
                <div class="card">
                    <div class="card-content">
                        <span class="currency">₱</span><span class="amount">{{ "%.0f"|format(data.current_balance|float) }}</span>
                    </div>
                    <div class="card-label">Coin Hopper Balance</div>
                </div>
            </div>

            <div class="charts">
                <div class="chart-box position-relative" style="cursor:pointer;" data-bs-toggle="modal" data-bs-target="#transactionModal">
                    <div class="card-label"><b>Transaction History</b></div>
                    <button type="button" class="btn btn-light rounded-circle position-absolute top-0 end-0 m-2"
                            data-bs-toggle="modal" data-bs-target="#transactionModal" title="View All">
                        <i class="fas fa-arrow-up-right-from-square"></i>
                    </button>
                    <canvas id="transactionMethodChart"></canvas>
                </div>

                <div class="sales-box">
                    <div class="card-label"><b>Sales in Year</b></div>
                    <canvas id="salesChart"></canvas>
                </div>
            </div>

            <div class="modal fade" id="transactionModal" tabindex="-1" aria-labelledby="transactionModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="transactionModalLabel">Transaction History</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <ul class="list-group" id="transaction-list">
                                {% for transaction in data.sales_history %}
                                <li class="list-group-item">
                                    <strong>{{ transaction.method }}</strong> - ₱{{ "%.2f"|format(transaction.amount|float) }}<br>
                                    <small class="text-muted">{{ transaction.date }} {{ transaction.time }}</small>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </content>
    </div> 

    <script>
        const salesChartLabels = {{ data.sales_chart_labels | tojson }};
        const salesChartValues = {{ data.sales_chart_values | tojson }};
        const transactionMethodData = {{ data.transaction_method_summary | tojson }};
        
        const socket = io(); 
        let salesYearChartInstance = null; 

        document.addEventListener('DOMContentLoaded', function() {
            
            const pieCtx = document.getElementById('transactionMethodChart').getContext('2d');
            const transactionMethodChart = new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: ['GCash', 'Coinslot'],
                    datasets: [{
                        label: 'Transaction Method',
                        data: [transactionMethodData.gcash, transactionMethodData.coinslot],
                        backgroundColor: ['rgba(54, 162, 235, 0.7)', 'rgba(255, 205, 86, 0.7)'],
                        borderColor: ['rgba(54, 162, 235, 1)', 'rgba(255, 205, 86, 1)'],
                        borderWidth: 1,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, 
                    layout: { padding: { top: 10, bottom: 10 } },
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 20, padding: 15, font: { size: 14 }, color: '#333'}},
                        tooltip: { callbacks: { label: function(context) { return `${context.label}: ₱${(context.parsed || 0).toFixed(2)}`; } } },
                    }
                }
            });

            const salesChartCanvas = document.getElementById('salesChart');
            if (salesChartCanvas) {
                const salesChartCtx = salesChartCanvas.getContext('2d');

                // Calculate dynamic min/max for y-axis
                let yAxisMin = 0;
                let yAxisMax = 10; // Default max if all data is 0

                if (salesChartValues && salesChartValues.length > 0) {
                    const positiveValues = salesChartValues.filter(v => v > 0);
                    const dataMax = Math.max(...salesChartValues, 0); // Ensure dataMax is at least 0
                    
                    if (dataMax > 0) {
                        const dataMin = positiveValues.length > 0 ? Math.min(...positiveValues) : 0;
                        const range = dataMax - dataMin;
                        const padding = Math.max(range * 0.1, 10); // Add at least 10 for padding or 10% of range

                        yAxisMin = Math.max(0, Math.floor(dataMin - padding / 2)); // Don't go too far below min, ensure >= 0
                        yAxisMax = Math.ceil(dataMax + padding);
                    }
                }


                salesYearChartInstance = new Chart(salesChartCtx, { 
                    type: 'bar',
                    data: {
                        labels: salesChartLabels, 
                        datasets: [{
                            label: `Sales in ${new Date().getFullYear()}`, 
                            data: salesChartValues, 
                            backgroundColor: 'rgba(112, 0, 0, 0.7)', 
                            borderColor: 'rgba(112, 0, 0, 1)',   
                            borderWidth: 1,
                            hoverBackgroundColor: 'rgba(140, 0, 0, 0.9)', 
                            hoverBorderColor: 'rgba(140, 0, 0, 1)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, 
                        scales: {
                            y: {
                                // beginAtZero: true, // Removed to allow dynamic min
                                min: yAxisMin,     // Set dynamic min
                                max: yAxisMax,     // Set dynamic max
                                ticks: {
                                    callback: function(value) {
                                        return '₱' + value.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                                    },
                                    color: '#333',
                                    // stepSize: Define if you want specific steps, e.g., 10 or 20
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)' 
                                }
                            },
                            x: { 
                                grid: { display: false }, 
                                ticks: {
                                    color: '#333' 
                                }
                            }
                        },
                        plugins: {
                            legend: { 
                                display: false, 
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0,0,0,0.7)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) { label += ': '; }
                                        if (context.parsed.y !== null) {
                                            label += '₱' + context.parsed.y.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            } else {
                console.error("Element with ID 'salesChart' not found for initialization.");
            }

            socket.on('new_transaction', function(data) {
                const totalSalesAmountSpan = document.querySelector('.stats .card:nth-child(1) .amount');
                if (totalSalesAmountSpan) {
                    let currentTotalText = totalSalesAmountSpan.textContent.replace(/[₱,]/g, '');
                    let currentTotalOnCard = parseFloat(currentTotalText) || 0;
                    currentTotalOnCard += parseFloat(data.amount);
                    totalSalesAmountSpan.textContent = currentTotalOnCard.toFixed(0); 
                }

                if (data.method === "GCash") {
                    transactionMethodChart.data.datasets[0].data[0] += parseFloat(data.amount);
                } else if (data.method === "Coinslot") {
                    transactionMethodChart.data.datasets[0].data[1] += parseFloat(data.amount);
                }
                transactionMethodChart.update();

                const transactionList = document.getElementById('transaction-list');
                if (transactionList) {
                    const newItem = document.createElement('li');
                    newItem.classList.add('list-group-item');
                    const formattedAmount = parseFloat(data.amount).toFixed(2);
                    newItem.innerHTML = `<strong>${data.method}</strong> - ₱${formattedAmount}<br><small class="text-muted">${data.timestamp}</small>`;
                    transactionList.prepend(newItem);
                    const maxItemsToShow = 10; 
                    while (transactionList.children.length > maxItemsToShow) {
                        transactionList.removeChild(transactionList.lastChild);
                    }
                }

                try {
                    const transactionDate = new Date(data.timestamp); 
                    const transactionMonth = transactionDate.getMonth(); 
                    const transactionYear = transactionDate.getFullYear();
                    
                    if (salesYearChartInstance && transactionYear === new Date().getFullYear() && transactionMonth >= 0 && transactionMonth < 12) {
                        // Update data
                        salesYearChartInstance.data.datasets[0].data[transactionMonth] += parseFloat(data.amount);
                        salesYearChartInstance.data.datasets[0].data[transactionMonth] = parseFloat(salesYearChartInstance.data.datasets[0].data[transactionMonth].toFixed(2));
                        
                        // Recalculate y-axis min/max after data update
                        const currentSalesData = salesYearChartInstance.data.datasets[0].data;
                        let newYMin = 0;
                        let newYMax = 10;
                        const positiveVals = currentSalesData.filter(v => v > 0);
                        const dataMaxNew = Math.max(...currentSalesData, 0);

                        if (dataMaxNew > 0) {
                            const dataMinNew = positiveVals.length > 0 ? Math.min(...positiveVals) : 0;
                            const rangeNew = dataMaxNew - dataMinNew;
                            const paddingNew = Math.max(rangeNew * 0.1, 10);
                            newYMin = Math.max(0, Math.floor(dataMinNew - paddingNew / 2));
                            newYMax = Math.ceil(dataMaxNew + paddingNew);
                        }
                        
                        salesYearChartInstance.options.scales.y.min = newYMin;
                        salesYearChartInstance.options.scales.y.max = newYMax;
                        salesYearChartInstance.update();
                    }
                } catch (e) {
                    console.error("Error parsing transaction timestamp for bar chart update:", data.timestamp, e);
                }
            });
        });
    </script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script> 
</body>
</html>
