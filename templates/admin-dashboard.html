<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/jpeg" href="{{ url_for('static', filename='images/logo.jpg') }}">
    <title>Uploaded Files</title>
    <link href="/static/css/admin-dashboard.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* CSS for layout, ensuring menu and content are positioned correctly */
        .container {
            display: flex;
        }
        .menu {
            flex-shrink: 0; 
        }
        .contents {
            flex-grow: 1; 
            /* Removed padding to reduce potential for scrolling */
        }
        /* Added style for files-header text */
        .files-header > div {
            font-weight: bold;
        }
        /* Ensure no overall scrolling */
        html, body {
            overflow: hidden;
            height: 100%; /* Ensure full height for consistent overflow handling */
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <leftmenu class="menu">
            <div class="account">
                <img src="{{ url_for('static', filename='images/logo.jpg') }}" alt="InstaPrint Logo" class="profile-icon" style="max-width: 75px;">
                <div class="account-info">
                    <p class="name">InstaPrint</p>
                    <p class="role">Admin</p>
                </div>
            </div>
            <ul>
                <li><i class="fa-solid fa-house"></i> <a href="{{ url_for('admin_dashboard') }}">Dashboard</a></li>
                <li><i class="fa-solid fa-print"></i> <a href="{{ url_for('admin_printed_pages') }}">Uploaded Files</a></li>
                <li><i class="fa-solid fa-comments"></i> <a href="{{ url_for('admin_feedbacks') }}">Feedbacks</a></li>
                <li><i class="fa-solid fa-upload"></i> <a href="{{ url_for('admin_activity_log') }}">Error Logs</a></li>
                <li><i class="fa-solid fa-chart-bar"></i> <a href="{{ url_for('admin_sales') }}">Total Sales</a></li>
            </ul>
        </leftmenu>

        <content class="contents">
            <!-- User Management Section -->
            <div class="user-management-section bg-light p-4 rounded shadow-sm mb-4">
                <h4 class="mb-3">Register New User</h4>
                <form id="registerUserForm" class="mb-4">
                    <div class="mb-3">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email address</label>
                        <input type="email" class="form-control" id="email" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Register User</button>
                    <div id="registerMessage" class="mt-2"></div>
                </form>

                <h4 class="mb-3">Existing Users</h4>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Registration Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                            {% for user in users %}
                            <tr>
                                <td>{{ user.id }}</td>
                                <td>{{ user.username }}</td>
                                <td>{{ user.email }}</td>
                                <td>{{ user.registration_date }}</td>
                                <td>
                                    <button class="btn btn-danger btn-sm delete-user-btn" data-id="{{ user.id }}">Delete</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- JavaScript for dynamic content and interactions -->
            <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const socket = io();

                    const userTableBody = document.getElementById('userTableBody');
                    const registerUserForm = document.getElementById('registerUserForm');
                    const registerMessage = document.getElementById('registerMessage');


                    // --- User Management Functions ---
                    // This function is initially handled by Jinja2, but this JS version
                    // allows dynamic updates if users are added/removed
                    function renderUsers(users) {
                        userTableBody.innerHTML = ''; // Clear existing rows
                        if (users.length === 0) {
                            userTableBody.innerHTML = '<tr><td colspan="5" class="text-center">No users registered yet.</td></tr>';
                            return;
                        }
                        users.forEach(user => {
                            const row = userTableBody.insertRow();
                            row.innerHTML = `
                                <td>${user.id}</td>
                                <td>${user.username}</td>
                                <td>${user.email}</td>
                                <td>${user.registration_date}</td>
                                <td>
                                    <button class="btn btn-danger btn-sm delete-user-btn" data-id="${user.id}">Delete</button>
                                </td>
                            `;
                        });
                        attachDeleteListeners();
                    }

                    function attachDeleteListeners() {
                        document.querySelectorAll('.delete-user-btn').forEach(button => {
                            button.onclick = function() {
                                const userId = this.dataset.id;
                                // In a production app, replace `confirm` with a custom modal UI.
                                if (confirm('Are you sure you want to delete this user?')) {
                                    fetch('/delete_user', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify({ id: userId })
                                    })
                                    .then(response => response.json())
                                    .then(data => {
                                        // In a production app, replace `alert` with a custom modal UI.
                                        if (data.success) {
                                            alert(data.message); 
                                            // User list will be refreshed by Socket.IO 'user_deleted' event
                                        } else {
                                            alert('Error: ' + data.message);
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Error deleting user:', error);
                                        alert('An error occurred while deleting the user.');
                                    });
                                }
                            };
                        });
                    }

                    // Function to fetch users from backend and re-render the table
                    async function fetchUsers() {
                        try {
                            // Fetch content from the admin_dashboard route and parse out the user table body
                            const response = await fetch('/admin-dashboard'); 
                            const text = await response.text();
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(text, 'text/html');
                            const newTableBody = doc.getElementById('userTableBody');
                            if (newTableBody) {
                                userTableBody.innerHTML = newTableBody.innerHTML;
                                attachDeleteListeners(); // Re-attach listeners to new buttons
                            } else {
                                console.error('Could not find #userTableBody in fetched content for user refresh.');
                            }
                        } catch (error) {
                            console.error('Error fetching users for refresh:', error);
                        }
                    }

                    // Attach listener for the register user form
                    if (registerUserForm) {
                        registerUserForm.addEventListener('submit', function(event) {
                            event.preventDefault();
                            const username = document.getElementById('username').value;
                            const email = document.getElementById('email').value;

                            fetch('/register_user', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ username: username, email: email })
                            })
                            .then(response => response.json())
                            .then(data => {
                                registerMessage.textContent = data.message;
                                registerMessage.className = data.success ? 'text-success' : 'text-danger';
                                if (data.success) {
                                    registerUserForm.reset();
                                    // User list will be refreshed by Socket.IO 'new_user' event
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                registerMessage.textContent = 'An error occurred during registration.';
                                registerMessage.className = 'text-danger';
                            });
                        });
                    }

                    // Initial attachment of delete listeners to users loaded via Jinja2
                    attachDeleteListeners();

                    // --- Socket.IO Event Listeners ---
                    socket.on('connect', function() {
                        console.log('Socket.IO connected!');
                    });

                    // Handler for new user registration updates
                    socket.on('new_user', function(user) {
                        console.log('New user added via Socket.IO:', user);
                        fetchUsers(); // Re-fetch and render the entire user list
                    });

                    // Handler for user deletion updates
                    socket.on('user_deleted', function(userId) {
                        console.log('User deleted via Socket.IO:', userId);
                        fetchUsers(); // Re-fetch and render the entire user list
                    });

                    // Handler for new transactions (kept for potential future use or other dashboard parts)
                    socket.on('new_transaction', function(data) {
                        console.log('New transaction via Socket.IO:', data);
                        // This event is primarily for the sales dashboard, but can be logged here if needed
                    });

                });
            </script>
        </content>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="./../static/js/main.js"></script>
</body>
</html>
